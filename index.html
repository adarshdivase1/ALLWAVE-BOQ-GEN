<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAV Pro - Enterprise Room Configurator & BOQ Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #16213e 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --surface-elevated: rgba(255, 255, 255, 0.1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow: hidden;
            line-height: 1.6;
        }
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.06) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 10px !important;
            padding: 12px 16px !important;
            color: white !important;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }
        
        .form-control:focus {
            outline: none !important;
            border-color: var(--accent-blue) !important;
            background: rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15) !important;
        }
        
        .form-control::placeholder { color: rgba(255, 255, 255, 0.5); }
        
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .btn:hover::before { transform: translateX(100%); }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #1d4ed8 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-indicator {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 8px currentColor;
        }
        
        .status-online { color: var(--accent-green); background: var(--accent-green); animation: pulse-green 2s infinite; }
        .status-offline { color: var(--error); background: var(--error); }
        .status-loading { color: var(--warning); background: var(--warning); animation: pulse-orange 1.5s infinite; }
        
        @keyframes pulse-green {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        @keyframes pulse-orange {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .panel {
            position: fixed;
            top: 20px;
            z-index: 100;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .control-panel { left: 20px; width: 420px; }
        .results-panel { right: 20px; width: 480px; }
        .product-panel { left: 460px; width: 380px; }
        
        .scrollbar-custom::-webkit-scrollbar { width: 6px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .scrollbar-custom::-webkit-scrollbar-thumb:hover { background: var(--accent-blue); }
        
        .loading-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
        }
        
        .spinner {
            width: 60px; height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .equipment-label {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            position: absolute;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            transform: translate(-50%, -120%);
            transition: opacity 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .boq-section {
            border-left: 3px solid var(--accent-blue);
            padding-left: 16px;
            margin-bottom: 24px;
        }
        
        .boq-item {
            background: var(--surface-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .boq-item:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .notification {
            position: relative;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success { background: rgba(16, 185, 129, 0.15); border-color: var(--accent-green); color: #34d399; }
        .notification.error { background: rgba(239, 68, 68, 0.15); border-color: var(--error); color: #f87171; }
        .notification.warning { background: rgba(245, 158, 11, 0.15); border-color: var(--warning); color: #fbbf24; }
        
        .room-preset {
            background: var(--surface-elevated);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .room-preset:hover, .room-preset.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 200;
        }
        
        .toolbar-btn {
            width: 48px; height: 48px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .progress-bar {
            width: 100%; height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .tab-container {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1; padding: 8px 16px;
            border-radius: 8px;
            text-align: center; cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500; font-size: 13px;
        }
        
        .tab.active { background: var(--accent-blue); color: white; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay flex-col items-center justify-center z-[999]" style="display: none;">
        <div class="spinner mb-6"></div>
        <div id="loadingText" class="text-white text-xl font-bold"></div>
        <div id="loadingSubtext" class="text-gray-400 text-sm mt-3"></div>
        <div class="progress-bar mt-6 w-64"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
    </div>

    <div id="renderContainer" class="fixed inset-0 z-0"></div>

    <div id="controlPanel" class="panel control-panel glass-panel p-6 scrollbar-custom">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-green-400 bg-clip-text text-transparent">SmartAV Pro</h1>
                <p class="text-sm text-gray-400 mt-1">Enterprise Room Configurator</p>
            </div>
            <div id="connectionStatus" class="flex items-center text-xs">
                <span class="status-indicator status-loading"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
        <div class="tab-container">
            <div class="tab active" data-tab="basic">Basic Setup</div>
            <div class="tab" data-tab="advanced">Advanced</div>
            <div class="tab" data-tab="templates">Templates</div>
        </div>
        <form id="configForm" class="space-y-6">
            <div id="tab-basic" class="tab-content"><div class="space-y-5"><div><h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-building mr-3 text-blue-400"></i> Project Information</h3><div class="space-y-3"><div><label class="block text-sm font-medium mb-2">Project Name</label><input type="text" id="project_name" class="form-control" value="Executive Conference Suite" required></div><div><label class="block text-sm font-medium mb-2">Client Organization</label><input type="text" id="client_name" class="form-control" value="Fortune 500 Corp" required></div></div></div><div><h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-cog mr-3 text-green-400"></i> Room Configuration</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium mb-2">Room Type</label><select id="room_size" class="form-control" required></select></div><div><label class="block text-sm font-medium mb-2">Primary Use</label><select id="use_case" class="form-control" required></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium mb-2">Budget Tier</label><select id="budget_range" class="form-control" required></select></div><div><label class="block text-sm font-medium mb-2">Max Occupancy</label><input type="number" id="occupancy" class="form-control" placeholder="12" min="2" max="500"></div></div></div></div><div><h4 class="text-md font-semibold mb-3 flex items-center"><i class="fas fa-ruler-combined mr-2 text-yellow-400"></i> Room Dimensions (feet)</h4><div class="grid grid-cols-3 gap-3"><div><label class="block text-sm font-medium mb-1">Length</label><input type="number" id="room_length" class="form-control" placeholder="24" min="8" max="100" step="0.5"></div><div><label class="block text-sm font-medium mb-1">Width</label><input type="number" id="room_width" class="form-control" placeholder="16" min="8" max="100" step="0.5"></div><div><label class="block text-sm font-medium mb-1">Height</label><input type="number" id="room_height" class="form-control" placeholder="10" min="8" max="20" step="0.5"></div></div></div></div></div>
            <div id="tab-advanced" class="tab-content" style="display: none;"><div class="space-y-5"><div><h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-sliders-h mr-3 text-purple-400"></i> Special Requirements</h3><div class="space-y-3"><div class="flex items-center"><input type="checkbox" id="req_wireless_presentation" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600"><label for="req_wireless_presentation" class="ml-3 text-sm">Wireless Presentation</label></div><div class="flex items-center"><input type="checkbox" id="req_video_conferencing" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600"><label for="req_video_conferencing" class="ml-3 text-sm">Video Conferencing</label></div><div class="flex items-center"><input type="checkbox" id="req_room_scheduling" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600"><label for="req_room_scheduling" class="ml-3 text-sm">Room Scheduling Panel</label></div></div></div></div></div>
            <div id="tab-templates" class="tab-content" style="display: none;"><div class="space-y-4"><h3 class="text-lg font-semibold mb-4 flex items-center"><i class="fas fa-layer-group mr-3 text-orange-400"></i> Quick Start Templates</h3><div class="grid grid-cols-1 gap-3" id="roomPresets"></div></div></div>
            <button type="submit" id="generateBtn" class="w-full btn btn-primary text-white font-bold flex items-center justify-center py-4"><i class="fas fa-magic mr-3"></i> Generate Smart Configuration</button>
        </form>
    </div>

    <div id="resultsPanel" class="panel results-panel glass-panel p-6 scrollbar-custom" style="display: none;">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold flex items-center"><i class="fas fa-chart-line mr-3 text-green-400"></i> Configuration Results</h2>
            <div class="flex space-x-2"><button id="exportBtn" title="Export BOQ as JSON" class="px-3 py-2 btn btn-primary text-sm"><i class="fas fa-download"></i></button><button id="clearBtn" title="Clear Results" class="px-3 py-2 btn btn-warning text-sm"><i class="fas fa-trash"></i></button></div>
        </div>
        <div id="resultsContent" class="space-y-4"></div>
    </div>

    <div class="toolbar">
        <button id="fullscreenBtn" class="toolbar-btn" title="Fullscreen"><i class="fas fa-expand"></i></button>
        <button id="screenshotBtn" class="toolbar-btn" title="Screenshot"><i class="fas fa-camera"></i></button>
    </div>

    <div id="notifications" class="fixed top-5 right-5 z-[1000] space-y-3 w-96"></div>
    <div id="equipmentInfo" class="equipment-info-panel"></div>

    <script>
        // === CONFIGURATION & STATE ===
        const CONFIG = {
            BACKEND_URL: 'https://adarshav-boq-backend.hf.space',
            TIMEOUT: 20000,
        };

        const STATE = {
            scene: null, camera: null, renderer: null, controls: null,
            equipmentObjects: [], currentBOQ: null, isLoading: false,
        };
        
        // Maps backend categories to 3D object parameters
        const EQUIPMENT_GEOMETRY_MAP = {
            'Displays & Projectors': { type: 'box', size: { w: 1.8, h: 1.0, d: 0.08 }, color: 0x1a1a1a, position: { x: 0, y: 1.5, z: -2.9 } },
            'UC & Collaboration Devices': { type: 'box', size: { w: 0.8, h: 0.15, d: 0.12 }, color: 0xcccccc, position: { x: 0, y: 2.2, z: -2.85 } },
            'Audio Systems': { type: 'box', size: { w: 0.2, h: 0.6, d: 0.2 }, color: 0x4a5568, positions: [{ x: -2.8, y: 1.5, z: -2.8 }, { x: 2.8, y: 1.5, z: -2.8 }] },
            'Mounts, Racks & Enclosures': { type: 'box', size: { w: 0.6, h: 1.8, d: 0.6 }, color: 0x2d3748, position: { x: 3.5, y: 0.9, z: 2.0 } },
            'default': { type: 'box', size: { w: 0.3, h: 0.3, d: 0.3 }, color: 0x718096, position: { x: 0, y: 0.15, z: 2.5 } }
        };

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', initializeApplication);

        async function initializeApplication() {
            try {
                showLoading('Initializing SmartAV Pro...', 'Loading 3D engine');
                await init3DScene();
                updateProgress(30);

                await loadFormOptions(); // CONNECTS TO BACKEND
                updateProgress(60);
                
                setupEventListeners();
                updateProgress(80);

                updateConnectionStatus('online');
                updateProgress(100);
                
                hideLoading();
                showNotification('SmartAV Pro initialized successfully!', 'success');
            } catch (error) {
                console.error('Initialization failed:', error);
                hideLoading();
                updateConnectionStatus('offline', 'Initialization Failed');
                showNotification(`Initialization failed: ${error.message}`, 'error');
            }
        }

        // === 3D SCENE MANAGEMENT ===
        async function init3DScene() {
            const container = document.getElementById('renderContainer');
            STATE.scene = new THREE.Scene();
            STATE.scene.background = new THREE.Color(0x0f1419);
            STATE.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            STATE.camera.position.set(6, 4, 8);
            STATE.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
            STATE.renderer.setSize(window.innerWidth, window.innerHeight);
            STATE.renderer.setPixelRatio(window.devicePixelRatio);
            STATE.renderer.shadowMap.enabled = true;
            container.appendChild(STATE.renderer.domElement);
            setupLighting();
            createRoom(24, 16, 10);
            setupControls();
            animate();
            window.addEventListener('resize', onWindowResize);
        }

        function setupLighting() {
            STATE.scene.add(new THREE.AmbientLight(0x404040, 0.8));
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(8, 10, 5);
            sunLight.castShadow = true;
            STATE.scene.add(sunLight);
            STATE.scene.add(new THREE.HemisphereLight(0x87ceeb, 0x080820, 0.5));
        }

        function setupControls() { /* This is a simplified orbit control implementation */
            const domElement = STATE.renderer.domElement;
            const target = new THREE.Vector3(0, 1, 0);
            let spherical = new THREE.Spherical().setFromVector3(STATE.camera.position.clone().sub(target));
            let state = { isDown: false, isPan: false, prev: { x: 0, y: 0 } };
            const update = () => { STATE.camera.position.setFromSpherical(spherical).add(target); STATE.camera.lookAt(target); };
            domElement.addEventListener('mousedown', e => { state.isDown = true; state.isPan = e.button === 2; state.prev = { x: e.clientX, y: e.clientY }; });
            document.addEventListener('mouseup', () => state.isDown = false);
            document.addEventListener('mousemove', e => {
                if (!state.isDown) return;
                const d = { x: e.clientX - state.prev.x, y: e.clientY - state.prev.y }; state.prev = { x: e.clientX, y: e.clientY };
                if (state.isPan) { const p = new THREE.Vector3(-d.x, d.y, 0).applyEuler(STATE.camera.rotation).multiplyScalar(0.01); target.add(p); } 
                else { spherical.theta -= d.x * 0.005; spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi - d.y * 0.005)); }
                update();
            });
            domElement.addEventListener('wheel', e => { spherical.radius = Math.max(2, Math.min(40, spherical.radius + e.deltaY * 0.01)); update(); });
            domElement.addEventListener('dblclick', () => { STATE.camera.position.set(6, 4, 8); target.set(0, 1, 0); spherical.setFromVector3(STATE.camera.position.clone().sub(target)); update(); });
            domElement.addEventListener('contextmenu', e => e.preventDefault());
        }
        
        function createRoom(length, width, height) { /* Creates the 3D room mesh */
            if (STATE.roomMesh) STATE.scene.remove(STATE.roomMesh);
            const roomGroup = new THREE.Group();
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(length, width), new THREE.MeshStandardMaterial({ color: 0x2d3748, roughness: 0.8 }));
            floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true; roomGroup.add(floor);
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x4a5568, side: THREE.DoubleSide, roughness: 0.9, transparent: true, opacity: 0.5 });
            const backWall = new THREE.Mesh(new THREE.PlaneGeometry(length, height), wallMat); backWall.position.set(0, height / 2, -width / 2); backWall.receiveShadow = true; roomGroup.add(backWall);
            const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(width, height), wallMat); leftWall.position.set(-length / 2, height / 2, 0); leftWall.rotation.y = Math.PI / 2; leftWall.receiveShadow = true; roomGroup.add(leftWall);
            STATE.roomMesh = roomGroup; STATE.scene.add(roomGroup);
        }

        function animate() { requestAnimationFrame(animate); STATE.renderer.render(STATE.scene, STATE.camera); }
        function onWindowResize() { STATE.camera.aspect = window.innerWidth / window.innerHeight; STATE.camera.updateProjectionMatrix(); STATE.renderer.setSize(window.innerWidth, window.innerHeight); }

        // === API & DATA HANDLING ===
        async function fetchAPI(endpoint, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}${endpoint}`, { ...options, signal: controller.signal, headers: { 'Content-Type': 'application/json', ...options.headers } });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `Server error: ${response.status}` }));
                    throw new Error(errorData.detail);
                }
                return response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function loadFormOptions() {
            showLoading('Connecting to backend...', 'Fetching configuration options');
            const enums = await fetchAPI('/api/enums');
            populateSelect(document.getElementById('room_size'), enums.room_sizes, 'medium');
            populateSelect(document.getElementById('use_case'), enums.use_cases, 'conference');
            populateSelect(document.getElementById('budget_range'), enums.budget_tiers, 'standard');
        }

        // === UI & EVENT HANDLERS ===
        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
            document.getElementById('configForm').addEventListener('submit', handleFormSubmit);
            ['room_length', 'room_width', 'room_height'].forEach(id => document.getElementById(id).addEventListener('input', updateRoomFromForm));
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
            document.getElementById('exportBtn').addEventListener('click', exportBOQ);
            document.getElementById('clearBtn').addEventListener('click', clearResults);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
        }

        function updateRoomFromForm() {
            const l = parseFloat(document.getElementById('room_length').value) || 24;
            const w = parseFloat(document.getElementById('room_width').value) || 16;
            const h = parseFloat(document.getElementById('room_height').value) || 10;
            createRoom(l, w, h);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            if (STATE.isLoading) return;
            STATE.isLoading = true;
            document.getElementById('generateBtn').disabled = true;

            try {
                showLoading('Generating Configuration...', 'Analyzing room parameters');
                updateProgress(25);
                
                const formData = collectFormData();
                const boq = await fetchAPI('/api/generate-boq', { method: 'POST', body: JSON.stringify(formData) });
                
                updateProgress(75);
                showLoading('Finalizing Results...', 'Creating 3D visualization');
                
                STATE.currentBOQ = boq;
                displayResults(boq);
                visualizeBOQ(boq); // Create 3D objects
                
                document.getElementById('resultsPanel').style.display = 'block';
                showNotification('Configuration generated successfully!', 'success');
            } catch (error) {
                console.error('Generation failed:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                hideLoading();
                STATE.isLoading = false;
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        function collectFormData() {
            return {
                project_name: document.getElementById('project_name').value,
                client_name: document.getElementById('client_name').value,
                room_size: document.getElementById('room_size').value,
                use_case: document.getElementById('use_case').value,
                budget_range: document.getElementById('budget_range').value,
                occupancy: parseInt(document.getElementById('occupancy').value) || null,
                room_dimensions: {
                    length: parseFloat(document.getElementById('room_length').value) || 24,
                    width: parseFloat(document.getElementById('room_width').value) || 16,
                    height: parseFloat(document.getElementById('room_height').value) || 10
                },
                special_requirements: [] // Placeholder for advanced features
            };
        }

        function displayResults(boq) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            // Summary
            let summaryHtml = `<div class="boq-section"><h3 class="text-lg font-bold text-white mb-3">Project Summary</h3><div class="grid grid-cols-2 gap-4">`;
            summaryHtml += `<div class="text-center"><div class="text-2xl font-bold text-green-400">$${boq.summary.total_cost.toLocaleString()}</div><div class="text-sm text-gray-400">Total Cost</div></div>`;
            summaryHtml += `<div class="text-center"><div class="text-2xl font-bold text-blue-400">${boq.summary.total_items}</div><div class="text-sm text-gray-400">Total Items</div></div>`;
            summaryHtml += `<div class="text-center col-span-2"><div class="text-xl font-bold text-purple-400">${boq.summary.estimated_installation_time}</div><div class="text-sm text-gray-400">Est. Install Time</div></div>`;
            summaryHtml += `</div></div>`;
            container.innerHTML += summaryHtml;
            
            // Sections and Items
            boq.sections.forEach(section => {
                let itemsHtml = section.items.map(item => `
                    <div class="boq-item">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-white">${item.name}</h4>
                                <p class="text-sm text-gray-400">${item.brand} ${item.part_number || ''}</p>
                            </div>
                            <div class="text-right ml-4">
                                <div class="font-bold text-green-400">$${item.total_price.toLocaleString()}</div>
                                <div class="text-xs text-gray-400">${item.quantity} × $${item.unit_price.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>`).join('');
                container.innerHTML += `<div class="boq-section"><h3 class="text-lg font-bold text-white mb-3">${section.name}</h3>${itemsHtml}</div>`;
            });
            
            // Recommendations
            if (boq.recommendations.length > 0) {
                let recsHtml = boq.recommendations.map(r => `<li class="text-gray-300">${r}</li>`).join('');
                container.innerHTML += `<div class="boq-section"><h3 class="text-lg font-bold text-white mb-3">Recommendations</h3><ul class="list-disc list-inside space-y-1">${recsHtml}</ul></div>`;
            }
        }
        
        function visualizeBOQ(boq) {
            clearEquipment();
            let audioCount = 0;
            boq.sections.forEach(section => {
                section.items.forEach(item => {
                    const geo = EQUIPMENT_GEOMETRY_MAP[item.category] || EQUIPMENT_GEOMETRY_MAP['default'];
                    let position = geo.position;
                    if (item.category === 'Audio Systems' && geo.positions) {
                        position = geo.positions[audioCount % geo.positions.length];
                        audioCount++;
                    }
                    if (position) {
                        const mesh = createEquipmentMesh(item, geo);
                        mesh.position.set(position.x, position.y, position.z);
                        STATE.scene.add(mesh);
                        STATE.equipmentObjects.push(mesh);
                    }
                });
            });
        }
        
        function createEquipmentMesh(item, geo) {
            const geometry = new THREE.BoxGeometry(geo.size.w, geo.size.h, geo.size.d);
            const material = new THREE.MeshStandardMaterial({ color: geo.color, roughness: 0.5 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.userData.info = `<strong>${item.name}</strong><br>${item.brand}`;
            return mesh;
        }

        function clearEquipment() {
            STATE.equipmentObjects.forEach(obj => STATE.scene.remove(obj));
            STATE.equipmentObjects = [];
        }

        // === UTILITY FUNCTIONS ===
        function populateSelect(el, opts, def) { el.innerHTML = ''; opts.forEach(o => { const opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.name; if(o.value === def) opt.selected = true; el.appendChild(opt); }); }
        function showLoading(text, subtext) { document.getElementById('loadingText').textContent = text; document.getElementById('loadingSubtext').textContent = subtext; document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; updateProgress(0); }
        function updateProgress(p) { document.getElementById('progressFill').style.width = `${p}%`; }
        function showNotification(msg, type) { const cont = document.getElementById('notifications'); const notif = document.createElement('div'); notif.className = `notification ${type}`; notif.innerHTML = `<div>${msg}</div>`; cont.appendChild(notif); setTimeout(() => notif.classList.add('show'), 10); setTimeout(() => { notif.classList.remove('show'); notif.addEventListener('transitionend', () => notif.remove()); }, 5000); }
        function updateConnectionStatus(status, text) { const el = document.getElementById('connectionStatus'); const ind = el.querySelector('.status-indicator'); ind.className = `status-indicator status-${status}`; document.getElementById('statusText').textContent = text || `${status.charAt(0).toUpperCase() + status.slice(1)}`; }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } }
        function takeScreenshot() { const dataURL = STATE.renderer.domElement.toDataURL('image/png'); const link = document.createElement('a'); link.download = 'smartav-config.png'; link.href = dataURL; link.click(); }
        function exportBOQ() { if(STATE.currentBOQ){ const d = JSON.stringify(STATE.currentBOQ, null, 2); const b = new Blob([d], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'boq.json'; a.click();} else { showNotification('No BOQ to export', 'warning');} }
        function clearResults() { document.getElementById('resultsContent').innerHTML = ''; document.getElementById('resultsPanel').style.display = 'none'; STATE.currentBOQ = null; clearEquipment(); showNotification('Results cleared', 'success'); }

    </script>
</body>
</html>
what seems to be the issue in this?

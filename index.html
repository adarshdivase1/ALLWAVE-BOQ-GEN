<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAV Pro - Enterprise Room Configurator & BOQ Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* All CSS styles from your original file go here. No changes needed. */
        :root { --primary-bg: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #16213e 100%); --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: rgba(255, 255, 255, 0.12); --accent-blue: #3b82f6; --accent-green: #10b981; --accent-purple: #8b5cf6; --warning: #f59e0b; --error: #ef4444; --text-primary: #ffffff; --text-secondary: #94a3b8; --surface-elevated: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Inter', sans-serif; background: var(--primary-bg); color: var(--text-primary); overflow: hidden; line-height: 1.6; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .form-control { background: rgba(255, 255, 255, 0.06) !important; border: 1px solid rgba(255, 255, 255, 0.15) !important; border-radius: 10px !important; padding: 12px 16px !important; color: white !important; font-size: 14px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; }
        .form-control:focus { outline: none !important; border-color: var(--accent-blue) !important; background: rgba(255, 255, 255, 0.1) !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15) !important; }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue) 0%, #1d4ed8 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px currentColor; }
        .status-online { color: var(--accent-green); background: var(--accent-green); }
        .status-offline { color: var(--error); background: var(--error); }
        .status-loading { color: var(--warning); background: var(--warning); animation: pulse-orange 1.5s infinite; }
        @keyframes pulse-orange { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .panel { position: fixed; top: 20px; z-index: 100; max-height: calc(100vh - 40px); overflow-y: auto; }
        .control-panel { left: 20px; width: 420px; }
        .results-panel { right: 20px; width: 480px; }
        .scrollbar-custom::-webkit-scrollbar { width: 6px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .loading-overlay { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px); }
        .spinner { width: 60px; height: 60px; border: 3px solid rgba(255, 255, 255, 0.2); border-top: 3px solid var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .boq-section { border-left: 3px solid var(--accent-blue); padding-left: 16px; margin-bottom: 24px; }
        .boq-item { background: var(--surface-elevated); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s ease; }
        .boq-item:hover { background: rgba(255, 255, 255, 0.12); border-color: var(--accent-blue); }
        .notification { position: relative; padding: 16px 24px; border-radius: 12px; font-weight: 600; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background: rgba(16, 185, 129, 0.15); border-color: var(--accent-green); color: #34d399; }
        .notification.error { background: rgba(239, 68, 68, 0.15); border-color: var(--error); color: #f87171; }
        .notification.warning { background: rgba(245, 158, 11, 0.15); border-color: var(--warning); color: #fbbf24; }
        .tab { flex: 1; padding: 8px 16px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 13px; }
        .tab.active { background: var(--accent-blue); color: white; }
        /* Add other styles as needed */
    </style>
</head>
<body>
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay flex-col items-center justify-center z-[999]" style="display: none;">
        <div class="spinner mb-6"></div>
        <div id="loadingText" class="text-white text-xl font-bold"></div>
    </div>
    <div id="renderContainer" class="fixed inset-0 z-0"></div>
    <div id="controlPanel" class="panel control-panel glass-panel p-6 scrollbar-custom">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-white">SmartAV Pro</h1>
            <div id="connectionStatus" class="flex items-center text-xs">
                <span class="status-indicator status-loading"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
        <form id="configForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Project Name</label>
                <input type="text" id="projectName" class="form-control" value="Executive Conference Suite" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Client Name</label>
                <input type="text" id="clientName" class="form-control" value="Global Tech Inc." required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Room Type</label>
                    <select id="roomSize" class="form-control" required></select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Primary Use</label>
                    <select id="useCase" class="form-control" required></select>
                </div>
            </div>
             <div>
                <label class="block text-sm font-medium mb-1">Budget Tier</label>
                <select id="budgetRange" class="form-control" required></select>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div><label class="block text-sm font-medium mb-1">Width (ft)</label><input type="number" id="roomWidth" class="form-control" value="16" required></div>
                <div><label class="block text-sm font-medium mb-1">Length (ft)</label><input type="number" id="roomLength" class="form-control" value="24" required></div>
                <div><label class="block text-sm font-medium mb-1">Height (ft)</label><input type="number" id="roomHeight" class="form-control" value="10" required></div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Special Requirements</label>
                <div class="space-y-2">
                    <div class="flex items-center"><input type="checkbox" id="req_video_conferencing" value="video_conferencing" class="h-4 w-4 rounded" checked><label for="req_video_conferencing" class="ml-2 text-sm">Video Conferencing</label></div>
                    <div class="flex items-center"><input type="checkbox" id="req_wireless_presentation" value="wireless_presentation" class="h-4 w-4 rounded" checked><label for="req_wireless_presentation" class="ml-2 text-sm">Wireless Presentation</label></div>
                    <div class="flex items-center"><input type="checkbox" id="req_room_scheduling" value="room_scheduling" class="h-4 w-4 rounded"><label for="req_room_scheduling" class="ml-2 text-sm">Room Scheduling Panel</label></div>
                </div>
            </div>
            <button type="submit" id="generateBtn" class="w-full btn btn-primary mt-4 py-3">Generate Smart Configuration</button>
        </form>
    </div>
    <div id="resultsPanel" class="panel results-panel glass-panel p-6 scrollbar-custom" style="display: none;">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Configuration Results</h2>
            <div><button id="exportBtn" title="Export JSON" class="px-3 py-1 btn btn-primary text-sm"><i class="fas fa-download"></i></button></div>
        </div>
        <div id="resultsContent" class="space-y-4"></div>
    </div>
    <div id="notifications" class="fixed top-5 right-5 z-[1000] space-y-3 w-96"></div>
    
    <script>
        const CONFIG = { BACKEND_URL: 'http://127.0.0.1:8000', TIMEOUT: 30000 };
        const STATE = { scene: null, camera: null, renderer: null, roomMesh: null, currentBOQ: null, isLoading: false };

        document.addEventListener('DOMContentLoaded', initializeApplication);

        async function initializeApplication() {
            try {
                showLoading('Initializing 3D Environment...');
                init3DScene();
                await loadFormOptions(); // THIS NOW WORKS
                updateConnectionStatus('online');
                setupEventListeners();
                hideLoading();
                showNotification('Application initialized successfully!', 'success');
            } catch (error) {
                console.error("Initialization failed:", error);
                updateConnectionStatus('offline', 'Initialization Failed');
                showNotification(`Initialization failed: ${error.message}`, 'error');
                hideLoading();
            }
        }

        function init3DScene() {
            const container = document.getElementById('renderContainer');
            STATE.scene = new THREE.Scene();
            STATE.scene.background = new THREE.Color(0x0f1419);
            STATE.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            STATE.camera.position.set(5, 4, 8);
            STATE.renderer = new THREE.WebGLRenderer({ antialias: true });
            STATE.renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(STATE.renderer.domElement);
            STATE.scene.add(new THREE.AmbientLight(0xcccccc));
            const light = new THREE.DirectionalLight(0xffffff, 0.7);
            light.position.set(5, 10, 7.5);
            STATE.scene.add(light);
            createRoom(16, 24, 10);
            animate();
            window.addEventListener('resize', onWindowResize);
        }

        function createRoom(width, length, height) {
            if (STATE.roomMesh) STATE.scene.remove(STATE.roomMesh);
            const geometry = new THREE.BoxGeometry(width, height, length);
            const material = new THREE.MeshStandardMaterial({ color: 0x4A5568, side: THREE.BackSide, transparent: true, opacity: 0.5 });
            STATE.roomMesh = new THREE.Mesh(geometry, material);
            STATE.roomMesh.position.y = height / 2;
            STATE.scene.add(STATE.roomMesh);
        }

        function animate() { requestAnimationFrame(animate); STATE.renderer.render(STATE.scene, STATE.camera); }
        function onWindowResize() { STATE.camera.aspect = window.innerWidth / window.innerHeight; STATE.camera.updateProjectionMatrix(); STATE.renderer.setSize(window.innerWidth, window.innerHeight); }

        async function fetchAPI(endpoint, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}${endpoint}`, { ...options, signal: controller.signal, headers: { 'Content-Type': 'application/json', ...options.headers } });
                clearTimeout(timeoutId);
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || `Server error: ${response.status}`);
                }
                return data;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function loadFormOptions() {
            showLoading('Fetching configuration options...');
            const enums = await fetchAPI('/api/enums');
            populateSelect(document.getElementById('roomSize'), enums.room_sizes, 'medium');
            populateSelect(document.getElementById('useCase'), enums.use_cases, 'video_conference');
            populateSelect(document.getElementById('budgetRange'), enums.budget_tiers, 'standard');
        }

        function setupEventListeners() {
            document.getElementById('configForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('exportBtn').addEventListener('click', exportBOQ);
            ['roomWidth', 'roomLength', 'roomHeight'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    const w = parseFloat(document.getElementById('roomWidth').value) || 16;
                    const l = parseFloat(document.getElementById('roomLength').value) || 24;
                    const h = parseFloat(document.getElementById('roomHeight').value) || 10;
                    createRoom(w, l, h);
                });
            });
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            if (STATE.isLoading) return;
            STATE.isLoading = true;
            document.getElementById('generateBtn').disabled = true;
            showLoading('Generating Smart Configuration...');

            try {
                const formData = collectFormData();
                const boq = await fetchAPI('/api/generate-boq', { method: 'POST', body: JSON.stringify(formData) });
                STATE.currentBOQ = boq;
                displayResults(boq);
                document.getElementById('resultsPanel').style.display = 'block';
                showNotification('Configuration generated successfully!', 'success');
            } catch (error) {
                console.error("Generation failed:", error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                hideLoading();
                STATE.isLoading = false;
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function collectFormData() {
            const specialRequirements = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                specialRequirements.push(cb.value);
            });
            
            // CORRECTED: Send dimensions as a list [width, length, height]
            return {
                projectName: document.getElementById('projectName').value,
                clientName: document.getElementById('clientName').value,
                roomSize: document.getElementById('roomSize').value,
                useCase: document.getElementById('useCase').value,
                budgetRange: document.getElementById('budgetRange').value,
                roomDimensions: [
                    parseFloat(document.getElementById('roomWidth').value),
                    parseFloat(document.getElementById('roomLength').value),
                    parseFloat(document.getElementById('roomHeight').value)
                ],
                specialRequirements: specialRequirements,
            };
        }

        function displayResults(boq) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = ''; // Clear previous results

            // --- Summary Section ---
            const summary = boq.summary;
            container.innerHTML += `
                <div class="boq-section">
                    <h3 class="text-lg font-bold mb-2">Project Summary</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><strong>Total Cost:</strong> <span class="text-green-400 font-bold">$${summary.totalCost.toLocaleString()}</span></div>
                        <div><strong>Total Items:</strong> ${summary.itemCount}</div>
                        <div><strong>Install Cost:</strong> $${summary.installationCost.toLocaleString()}</div>
                        <div><strong>Install Days:</strong> ${summary.estimatedInstallDays}</div>
                    </div>
                </div>`;

            // --- Room Analysis Section ---
            const analysis = boq.roomAnalysis;
            container.innerHTML += `
                <div class="boq-section">
                    <h3 class="text-lg font-bold mb-2">Room Analysis</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><strong>Area:</strong> ${analysis.roomArea} sqft</div>
                        <div><strong>Capacity:</strong> ~${analysis.recommendedCapacity} people</div>
                        <div><strong>Acoustics:</strong> <span class="font-semibold">${analysis.acousticRating}</span></div>
                        <div><strong>Complexity:</strong> ${analysis.complexityScore}/10</div>
                    </div>
                </div>`;
            
            // --- BOQ Sections & Items ---
            boq.sections.forEach(section => {
                let itemsHtml = section.items.map(item => `
                    <div class="boq-item">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-white">${item.name}</h4>
                                <p class="text-sm text-gray-400">${item.brand}</p>
                            </div>
                            <div class="text-right ml-4">
                                <div class="font-bold text-green-400">$${item.totalPrice.toLocaleString()}</div>
                                <div class="text-xs text-gray-400">${item.quantity} × $${item.unitPrice.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>`).join('');
                container.innerHTML += `<div class="boq-section"><h3 class="text-lg font-bold mb-3">${section.name}</h3>${itemsHtml}</div>`;
            });

            // --- Recommendations ---
            if (boq.recommendations && boq.recommendations.length > 0) {
                 let recsHtml = boq.recommendations.map(r => `<li class="text-gray-300 text-sm">${r}</li>`).join('');
                container.innerHTML += `<div class="boq-section"><h3 class="text-lg font-bold mb-3">Recommendations</h3><ul class="list-disc list-inside space-y-1">${recsHtml}</ul></div>`;
            }
        }

        function exportBOQ() {
            if (STATE.currentBOQ) {
                const dataStr = JSON.stringify(STATE.currentBOQ, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${STATE.currentBOQ.projectName.replace(/\s/g, '_')}_BOQ.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                showNotification('No BOQ to export.', 'warning');
            }
        }

        function populateSelect(el, opts, def) { el.innerHTML = ''; opts.forEach(o => { const opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.name; if(o.value === def) opt.selected = true; el.appendChild(opt); }); }
        function showLoading(text) { document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
        function showNotification(msg, type) { const cont = document.getElementById('notifications'); const notif = document.createElement('div'); notif.className = `notification ${type}`; notif.innerHTML = `<div>${msg}</div>`; cont.appendChild(notif); setTimeout(() => notif.classList.add('show'), 10); setTimeout(() => { notif.classList.remove('show'); notif.addEventListener('transitionend', () => notif.remove()); }, 5000); }
        function updateConnectionStatus(status, text) { const el = document.getElementById('connectionStatus'); const ind = el.querySelector('.status-indicator'); ind.className = `status-indicator status-${status}`; document.getElementById('statusText').textContent = text || `${status.charAt(0).toUpperCase() + status.slice(1)}`; }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional BOQ Generator v5.0 - Production Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --success-green: #10b981;
            --warning-amber: #f59e0b;
        }
        body { font-family: 'Inter', sans-serif; background: var(--primary-gradient); min-height: 100vh; color: white; overflow-x: hidden; }
        .glassmorphism { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); }
        .premium-glass { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2); }
        .floating-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(0px); }
        .floating-card:hover { transform: translateY(-4px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25); }
        .gradient-button { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .gradient-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .gradient-button:hover::before { left: 100%; }
        .toast { position: fixed; top: 20px; right: 20px; z-index: 1000; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-width: 400px; }
        .toast.show { transform: translateX(0); }
        .virtual-scroll { height: 600px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .virtual-scroll::-webkit-scrollbar { width: 8px; background: rgba(0, 0, 0, 0.1); }
        .virtual-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 8px; }
        .virtual-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
        .loading-spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 2px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-connected { background: var(--success-green); }
        .status-connecting { background: var(--warning-amber); }
        .status-disconnected { background: #ef4444; }
        .boq-header { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3); position: relative; overflow: hidden; }
        .boq-header::before { content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%; transform: translate(50px, -50px); }
        .boq-section { border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; background: var(--glass-bg); backdrop-filter: blur(12px); transition: all 0.3s ease; }
        .boq-section:hover { border-color: rgba(255, 255, 255, 0.25); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); }
        .boq-section-header { background: rgba(0, 0, 0, 0.3); color: white; font-weight: 600; padding: 1rem 1.5rem; border-bottom: 1px solid var(--glass-border); position: relative; }
        .boq-table { width: 100%; border-collapse: collapse; }
        .boq-table th { background: rgba(0, 0, 0, 0.2); color: white; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--glass-border); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .boq-table td { padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); vertical-align: top; color: rgba(255, 255, 255, 0.9); transition: all 0.2s ease; }
        .boq-table tr:hover { background: rgba(255, 255, 255, 0.08); transform: scale(1.001); }
        .item-name { font-weight: 600; color: white; margin-bottom: 0.5rem; font-size: 1rem; }
        .item-brand { color: #93c5fd; font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 500; }
        .item-features { color: rgba(255, 255, 255, 0.75); font-size: 0.8rem; line-height: 1.5; margin-bottom: 0.25rem; }
        .item-specs { color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; font-style: italic; }
        .section-total { background: rgba(0, 0, 0, 0.3); font-weight: 700; color: #fbbf24; font-size: 1.1rem; }
        .grand-total-section { background: linear-gradient(135deg, #047857, #059669); color: white; padding: 2rem; border-radius: 12px; margin-top: 2rem; box-shadow: 0 8px 32px rgba(4, 120, 87, 0.3); position: relative; overflow: hidden; }
        .grand-total-section::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%); }
        .recommendations-section { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; backdrop-filter: blur(10px); }
        .assumptions-section { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; backdrop-filter: blur(10px); }
        .terms-section { background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; backdrop-filter: blur(10px); }
        .form-group { position: relative; margin-bottom: 1.5rem; }
        .form-label { display: block; color: rgba(255, 255, 255, 0.9); font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input { width: 100%; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 8px !important; padding: 12px 16px !important; color: white !important; font-size: 1rem; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .form-input:focus { outline: none !important; border-color: var(--accent-blue) !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important; background: rgba(255, 255, 255, 0.15) !important; }
        .form-input::placeholder { color: rgba(255, 255, 255, 0.5) !important; }
        .smart-suggestions { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 1rem; margin-top: 0.5rem; }
        .suggestion-item { display: flex; align-items: center; padding: 0.5rem; margin: 0.25rem 0; background: rgba(255, 255, 255, 0.05); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .suggestion-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(4px); }
        .progress-bar { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); border-radius: 2px; transition: width 0.5s ease; }
        .print-hidden { display: none; }
        @media print {
            body { background: white !important; color: black !important; }
            .glassmorphism, .premium-glass { background: white !important; backdrop-filter: none !important; border: 1px solid #e5e7eb !important; box-shadow: none !important; }
            .boq-header, .boq-section-header, .grand-total-section { background: #f8fafc !important; color: black !important; box-shadow: none !important; }
            .boq-table th { background: #f1f5f9 !important; color: black !important; }
            .item-name, .item-brand { color: black !important; }
            .item-features, .item-specs { color: #64748b !important; }
            .print-hidden { display: none !important; }
            .form-input { background: white !important; color: black !important; border-color: #d1d5db !important; }
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in-right { animation: slideInRight 0.5s ease-out; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="p-4 min-h-screen flex items-center justify-center">
    <div id="toastContainer"></div>
    
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="premium-glass rounded-xl p-8 flex items-center space-x-4 max-w-md">
            <div class="loading-spinner"></div>
            <div class="text-center">
                <div class="text-white font-semibold text-lg" id="loadingText">Generating Professional BOQ...</div>
                <div class="text-white/70 text-sm mt-1" id="loadingSubtext">Contacting AI backend and building system...</div>
                <div class="progress-bar mt-3">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="premium-glass rounded-3xl shadow-2xl max-w-8xl w-full p-8 space-y-8 floating-card">
        <div class="text-center text-white fade-in">
            <div class="flex items-center justify-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mr-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        Professional BOQ Generator v5.0
                    </h1>
                    <p class="text-white/80 text-lg">Advanced AV System Design & Quotation Platform</p>
                </div>
            </div>
            
            <div class="flex items-center justify-center space-x-6 text-sm">
                <div class="flex items-center">
                    <span id="statusIndicator" class="status-indicator status-connecting pulse-animation"></span>
                    <span id="appStatus" class="font-medium">Connecting...</span>
                </div>
                <div class="text-white/60">|</div>
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    </svg>
                    <span class="text-green-400">Smart Ecosystem Detection</span>
                </div>
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-blue-400">Production Ready</span>
                </div>
            </div>
        </div>

        <div class="grid xl:grid-cols-2 gap-8">
            <div class="space-y-6">
                <div class="premium-glass rounded-2xl p-8 border border-white/20 floating-card slide-in-right">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-white">Project Configuration</h2>
                    </div>
                    
                    <form id="boqForm" class="space-y-6" novalidate>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="form-label">Project Name *</label>
                                <input type="text" id="projectName" class="form-input" placeholder="e.g., Executive Conference Room" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Name *</label>
                                <input type="text" id="clientName" class="form-input" placeholder="e.g., ABC Corporation Ltd." required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="form-label">Project Location</label>
                                <input type="text" id="projectLocation" class="form-input" placeholder="e.g., Mumbai, India">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Project Date</label>
                                <input type="date" id="projectDate" class="form-input">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="form-label">Room Size</label>
                                <select id="roomSize" class="form-input">
                                    <option value="small">Small Room (4-8 people)</option>
                                    <option value="medium" selected>Medium Room (8-16 people)</option>
                                    <option value="large">Large Room (16-30 people)</option>
                                    <option value="xlarge">Extra Large (30+ people)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Use Case</label>
                                <select id="useCase" class="form-input">
                                    <option value="meeting_room">Meeting Room</option>
                                    <option value="boardroom">Executive Boardroom</option>
                                    <option value="huddle_room">Huddle Room</option>
                                    <option value="training_room">Training Room</option>
                                    <option value="auditorium">Auditorium</option>
                                    <option value="telepresence">Telepresence Room</option>
                                    <option value="lecture_hall">Lecture Hall</option>
                                    <option value="creative_space">Creative Collaboration Space</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Brand Preference & Technical Requirements</label>
                            <textarea id="projectRequirements" rows="3" class="form-input" placeholder="e.g., Prefer Logitech ecosystem, require 4K displays, wireless presentation, Microsoft Teams certified, budget conscious..."></textarea>
                            <div id="smartSuggestions" class="smart-suggestions hidden">
                                <div class="text-sm text-green-300 font-medium mb-2">ðŸ’¡ Smart Suggestions Detected:</div>
                                <div id="detectedBrands" class="space-y-1"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div class="form-group">
                                <label class="form-label">Budget Range</label>
                                <select id="budgetRange" class="form-input">
                                    <option value="economy">Economy ($5K-15K)</option>
                                    <option value="standard" selected>Standard ($15K-35K)</option>
                                    <option value="premium">Premium ($35K-75K)</option>
                                    <option value="enterprise">Enterprise ($75K+)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority Focus</label>
                                <select id="priority" class="form-input">
                                    <option value="balanced" selected>Balanced</option>
                                    <option value="cost">Cost Optimized</option>
                                    <option value="quality">Quality First</option>
                                    <option value="reliability">Reliability</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contingency %</label>
                                <input type="number" id="contingency" value="15" min="0" max="50" class="form-input">
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" id="generateBtn" class="w-full gradient-button text-white font-semibold py-4 px-8 rounded-xl flex items-center justify-center transition-all duration-300 text-lg">
                                <span id="generateText">Generate Professional BOQ</span>
                                <div id="generateSpinner" class="hidden loading-spinner w-6 h-6 ml-3"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="premium-glass rounded-2xl p-8 border border-white/20 floating-card">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-semibold text-white">Professional BOQ</h2>
                        </div>
                        <div id="boqActions" class="hidden space-x-3">
                            <button id="printBoqBtn" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg transition-colors shadow-lg hover:shadow-xl" title="Print BOQ">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zM5 14H4v-3h1v3zm5 4H7v-3h3v3zm4 0v-3h1v3h-1z"/>
                                </svg>
                            </button>
                            <button id="downloadCsvBtn" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg transition-colors shadow-lg hover:shadow-xl" title="Download CSV">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
                                </svg>
                            </button>
                            <button id="exportPdfBtn" class="bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-lg transition-colors shadow-lg hover:shadow-xl" title="Export PDF">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div id="boqContent" class="virtual-scroll">
                        <div id="emptyState" class="text-center py-16">
                            <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center">
                                <svg class="w-12 h-12 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h8a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v1a2 2 0 012 2v10a4 4 0 01-4 4H6a4 4 0 01-4-4V5z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-white/80 mb-2">Ready to Generate</h3>
                            <p class="text-white/60 max-w-md mx-auto">Configure your project requirements and generate a professional BOQ with smart recommendations and detailed specifications.</p>
                        </div>
                        
                        <div id="boqDisplay" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentBOQ = null;
        let isGenerating = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            bindEventListeners();
            setupSmartSuggestions();
        });

        function initializeApp() {
            // Set default date
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            
            // Update status
            setTimeout(() => {
                updateAppStatus('connected', 'System Ready');
            }, 1500);
        }

        function updateAppStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('appStatus');
            
            indicator.className = `status-indicator status-${status}`;
            if (status === 'connecting') {
                indicator.classList.add('pulse-animation');
            } else {
                indicator.classList.remove('pulse-animation');
            }
            
            statusText.textContent = message;
        }

        function bindEventListeners() {
            // Form submission
            document.getElementById('boqForm').addEventListener('submit', handleFormSubmit);
            
            // Action buttons
            document.getElementById('printBoqBtn').addEventListener('click', printBOQ);
            document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
            document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
        }

        function setupSmartSuggestions() {
            const requirementsField = document.getElementById('projectRequirements');
            
            requirementsField.addEventListener('input', function() {
                const text = this.value.toLowerCase();
                const suggestions = document.getElementById('smartSuggestions');
                const brandsContainer = document.getElementById('detectedBrands');
                
                // Brand detection
                const brands = ['logitech', 'cisco', 'microsoft', 'zoom', 'poly', 'crestron', 'extron', 'samsung', 'lg'];
                const detectedBrands = brands.filter(brand => text.includes(brand));
                
                if (detectedBrands.length > 0) {
                    brandsContainer.innerHTML = detectedBrands.map(brand => 
                        `<div class="suggestion-item">
                            <span class="text-green-400 mr-2">âœ“</span>
                            <span class="capitalize">${brand} ecosystem detected</span>
                        </div>`
                    ).join('');
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (isGenerating) return;
            
            const formData = getFormData();
            if (!validateFormData(formData)) return;
            
            await generateBOQ(formData);
        }

        function getFormData() {
            return {
                projectName: document.getElementById('projectName').value,
                clientName: document.getElementById('clientName').value,
                projectLocation: document.getElementById('projectLocation').value,
                projectDate: document.getElementById('projectDate').value,
                roomSize: document.getElementById('roomSize').value,
                useCase: document.getElementById('useCase').value,
                requirements: document.getElementById('projectRequirements').value,
                budgetRange: document.getElementById('budgetRange').value,
                priority: document.getElementById('priority').value,
                contingency: parseFloat(document.getElementById('contingency').value) || 15
            };
        }

        function validateFormData(data) {
            if (!data.projectName.trim()) {
                showToast('Please enter a project name', 'error');
                return false;
            }
            if (!data.clientName.trim()) {
                showToast('Please enter a client name', 'error');
                return false;
            }
            return true;
        }

        async function generateBOQ(formData) {
            isGenerating = true;
            showLoadingOverlay();
            
            try {
                // Simulate loading with progress
                await simulateProgress();
                
                // *** CHANGE: Call the backend to generate BOQ data ***
                const boqData = await fetchBOQFromBackend(formData);
                currentBOQ = boqData;
                
                // Display BOQ
                displayBOQ(boqData);
                
                showToast('BOQ generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating BOQ:', error);
                const errorMessage = error.message || 'Error generating BOQ. Please check the console and try again.';
                showToast(errorMessage, 'error');
            } finally {
                hideLoadingOverlay();
                isGenerating = false;
            }
        }
        
        async function simulateProgress() {
            const stages = [
                { text: 'Validating configuration...', subtext: 'Sending request to AI backend', progress: 20 },
                { text: 'Backend processing...', subtext: 'Building logical system based on requirements', progress: 50 },
                { text: 'Receiving BOQ data...', subtext: 'Finalizing pricing and compatibility checks', progress: 80 },
                { text: 'Rendering document...', subtext: 'Preparing professional documentation', progress: 100 }
            ];
            
            for (const stage of stages) {
                document.getElementById('loadingText').textContent = stage.text;
                document.getElementById('loadingSubtext').textContent = stage.subtext;
                document.getElementById('progressFill').style.width = stage.progress + '%';
                await new Promise(resolve => setTimeout(resolve, 800));
            }
        }

        // *** NEW FUNCTION to connect to the backend ***
        async function fetchBOQFromBackend(formData) {
            const backendUrl = 'https://adarshav-boq-backend.hf.space/api/generate_boq';

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    // Try to parse the error message from the backend if available
                    const errorData = await response.json().catch(() => null);
                    const detail = errorData?.detail || `HTTP error! status: ${response.status}`;
                    throw new Error(`Backend Error: ${detail}`);
                }

                const boqData = await response.json();
                
                // The backend now provides the full BOQ object, so we can use it directly
                return boqData;

            } catch (error) {
                console.error('Failed to fetch BOQ from backend:', error);
                // Re-throw the error to be caught by the main generateBOQ function
                throw error;
            }
        }
        
        function displayBOQ(boqData) {
            const boqDisplay = document.getElementById('boqDisplay');
            const emptyState = document.getElementById('emptyState');
            const actions = document.getElementById('boqActions');
            
            // Hide empty state and show actions
            emptyState.classList.add('hidden');
            boqDisplay.classList.remove('hidden');
            actions.classList.remove('hidden');
            
            let html = `
                <div class="boq-header fade-in">
                    <div style="position: relative; z-index: 1;">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h1 class="text-3xl font-bold mb-2">${boqData.projectName}</h1>
                                <p class="text-blue-100 text-lg">${boqData.clientName}</p>
                                ${boqData.metadata.projectLocation ? `<p class="text-blue-200 text-sm mt-1">${boqData.metadata.projectLocation}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-blue-200">BOQ Reference</div>
                                <div class="font-mono text-lg">#${boqData.id.slice(-8).toUpperCase()}</div>
                                <div class="text-sm text-blue-200 mt-1">${new Date(boqData.generatedAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-6 text-center">
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="text-2xl font-bold text-blue-200">${boqData.summary.itemCount}</div>
                                <div class="text-sm text-blue-100">Items</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="text-2xl font-bold text-green-200">$${Math.round(boqData.summary.totalCost).toLocaleString()}</div>
                                <div class="text-sm text-green-100">Total Value</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="text-2xl font-bold text-purple-200">${boqData.sections.length}</div>
                                <div class="text-sm text-purple-100">Sections</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add sections
            boqData.sections.forEach((section, index) => {
                html += `
                    <div class="boq-section slide-in-right" style="animation-delay: ${index * 0.1}s;">
                        <div class="boq-section-header">
                            <div class="flex justify-between items-center">
                                <span>${section.name}</span>
                                <span class="font-mono">$${Math.round(section.sectionTotal).toLocaleString()}</span>
                            </div>
                        </div>
                        <table class="boq-table">
                            <thead>
                                <tr>
                                    <th width="40%">Item Details</th>
                                    <th width="15%">Quantity</th>
                                    <th width="20%">Unit Price</th>
                                    <th width="25%">Total Price</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                section.items.forEach(item => {
                    html += `
                        <tr>
                            <td>
                                <div class="item-name">${item.name}</div>
                                <div class="item-brand">${item.brand}</div>
                                <div class="item-features">${item.features || ''}</div>
                                <div class="item-specs">${item.specifications || ''}</div>
                            </td>
                            <td class="text-center font-mono">${item.quantity}</td>
                            <td class="text-right font-mono">$${Math.round(item.unitPrice).toLocaleString()}</td>
                            <td class="text-right font-mono font-semibold">$${Math.round(item.totalPrice).toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                html += `
                                <tr class="section-total">
                                    <td colspan="3" class="text-right font-semibold">Section Total:</td>
                                    <td class="text-right font-mono">$${Math.round(section.sectionTotal).toLocaleString()}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            // Add summary
            html += `
                <div class="grand-total-section fade-in">
                    <div style="position: relative; z-index: 1;">
                        <h3 class="text-2xl font-bold mb-6">Project Summary</h3>
                        
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <div class="flex justify-between py-2">
                                    <span>Subtotal:</span>
                                    <span class="font-mono">$${Math.round(boqData.summary.subtotal).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between py-2">
                                    <span>Contingency (${boqData.metadata.contingency}%):</span>
                                    <span class="font-mono">$${Math.round(boqData.summary.contingencyAmount).toLocaleString()}</span>
                                </div>
                                </div>
                            <div class="border-l border-green-300 pl-6">
                                <div class="text-right">
                                    <div class="text-lg text-green-200">Grand Total</div>
                                    <div class="text-4xl font-bold font-mono">$${Math.round(boqData.summary.totalCost).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="recommendations-section fade-in">
                    <h4 class="text-lg font-semibold mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                        </svg>
                        Smart Recommendations
                    </h4>
                    <ul class="space-y-2 text-sm">
                        ${boqData.recommendations.map(rec => `<li class="flex items-start"><span class="text-green-400 mr-2 mt-1">â€¢</span>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="assumptions-section fade-in">
                    <h4 class="text-lg font-semibold mb-3 flex items-center text-amber-300">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"/>
                        </svg>
                        Project Assumptions
                    </h4>
                    <ul class="space-y-2 text-sm text-amber-100">
                        ${boqData.assumptions.map(assump => `<li>â€¢ ${assump}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="terms-section fade-in">
                    <h4 class="text-lg font-semibold mb-3 flex items-center text-purple-300">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H9z" />
                           <path d="M4 12a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5z" />
                        </svg>
                        Terms & Conditions
                    </h4>
                    <ul class="space-y-2 text-sm text-purple-100">
                        ${boqData.terms_conditions.map(term => `<li>â€¢ ${term}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            boqDisplay.innerHTML = html;
            
            // Add animation classes
            setTimeout(() => {
                const elements = boqDisplay.querySelectorAll('.fade-in, .slide-in-right');
                elements.forEach(el => el.style.opacity = '1');
            }, 100);
        }

        // Utility functions (largely unchanged)
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateSpinner = document.getElementById('generateSpinner');
            
            generateBtn.disabled = true;
            generateText.textContent = 'Generating...';
            generateSpinner.classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateSpinner = document.getElementById('generateSpinner');
            
            generateBtn.disabled = false;
            generateText.textContent = 'Generate Professional BOQ';
            generateSpinner.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 
                '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>' :
                '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"/></svg>';
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast premium-glass ${bgColor} text-white p-4 rounded-xl flex items-center space-x-3 shadow-lg`;
            toast.innerHTML = `
                <div class="flex-shrink-0">${icon}</div>
                <div class="flex-1">
                    <div class="font-medium">${message}</div>
                </div>
                <button onclick="removeToast('${toastId}')" class="flex-shrink-0 text-white/80 hover:text-white">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                    </svg>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => removeToast(toastId), 5000);
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }
        }

        function printBOQ() {
            if (!currentBOQ) return;
            
            const printContent = document.getElementById('boqDisplay').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>BOQ - ${currentBOQ.projectName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        h1, h2, h3 { color: #000; }
                        .boq-header { background: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
                        .boq-section { border: 1px solid #dee2e6; margin-bottom: 20px; border-radius: 8px; overflow: hidden; page-break-inside: avoid; }
                        .boq-section-header { background: #e9ecef; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; }
                        .boq-table { width: 100%; border-collapse: collapse; }
                        .boq-table th, .boq-table td { padding: 10px; border-bottom: 1px solid #dee2e6; text-align: left; vertical-align: top; }
                        .boq-table th { background: #f1f3f5; }
                        .boq-table tr:last-child td { border-bottom: none; }
                        .item-name { font-weight: bold; }
                        .item-brand { color: #555; font-size: 0.9em; }
                        .item-features, .item-specs { font-size: 0.8em; color: #666; }
                        .section-total { background: #f1f3f5; font-weight: bold; }
                        .text-right { text-align: right; }
                        .grand-total-section { background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; margin-top: 20px; }
                        ul { padding-left: 20px; } li { margin-bottom: 5px; }
                    </style>
                </head>
                <body>${printContent}</body>
                </html>`);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
        }

        function downloadCSV() {
            if (!currentBOQ) return;
            
            let csv = 'Section,Item Name,Brand,Model,Features,Quantity,Unit Price,Total Price\n';
            
            currentBOQ.sections.forEach(section => {
                section.items.forEach(item => {
                    csv += `"${section.name}","${item.name}","${item.brand}","${item.model || ''}","${(item.features || '').replace(/"/g, '""')}",${item.quantity},${item.unitPrice},${item.totalPrice}\n`;
                });
            });
            
            // Add summary
            csv += '\n';
            csv += `"SUMMARY","Subtotal","","","",1,${currentBOQ.summary.subtotal},${currentBOQ.summary.subtotal}\n`;
            csv += `"SUMMARY","Contingency (${currentBOQ.metadata.contingency}%)","","","",1,${currentBOQ.summary.contingencyAmount},${currentBOQ.summary.contingencyAmount}\n`;
            csv += `"SUMMARY","Grand Total","","","",1,${currentBOQ.summary.totalCost},${currentBOQ.summary.totalCost}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `BOQ_${currentBOQ.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV downloaded successfully!', 'success');
        }

        function exportPDF() {
            if (!currentBOQ) return;
            showToast('PDF export feature coming soon! Use Print for now.', 'info');
        }

        window.addEventListener('load', function() {
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);
        });

    </script>
</body>
</html>

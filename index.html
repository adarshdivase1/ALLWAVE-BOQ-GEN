<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced 3D AV Room Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --success-green: #10b981;
            --error-red: #ef4444;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            color: white;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .premium-glass {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        .control-panel, .boq-panel {
            position: fixed;
            top: 20px;
            z-index: 100;
            max-width: 450px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        .control-panel { left: 20px; }
        .boq-panel { right: 20px; }
        
        .equipment-item {
            cursor: grab;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .equipment-item:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .equipment-item:active { cursor: grabbing; transform: scale(0.98); }
        
        .form-input, .form-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            color: white !important;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus {
            border-color: var(--accent-blue) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            outline: none !important;
        }
        
        .form-select option { background: #1a1a2e; color: white; }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
        }
        
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .virtual-scroll::-webkit-scrollbar { width: 8px; }
        .virtual-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 8px; }
        .virtual-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 8px; }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .boq-section { border-left: 4px solid var(--accent-blue); padding-left: 16px; margin-bottom: 20px; }
        
        .boq-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--success-green);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .boq-item:hover { background: rgba(255, 255, 255, 0.12); transform: translateX(4px); }
        
        #renderContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #renderContainer canvas { display: block; width: 100%; height: 100%; cursor: grab; }
        #renderContainer canvas:active { cursor: grabbing; }

    </style>
</head>
<body>
    <div id="toastContainer"></div>
    
    <div id="loadingOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center z-50 hidden">
        <div class="loading-spinner mb-4"></div>
        <div class="text-white text-lg font-semibold">Contacting AI Backend...</div>
        <div class="text-white/70 text-sm mt-2">Analyzing room requirements</div>
    </div>
    
    <div id="renderContainer"></div>
    
    <div class="control-panel premium-glass rounded-2xl p-6 virtual-scroll">
        <h2 class="text-xl font-bold mb-4 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">üèóÔ∏è Room Designer Pro</h2>
        
        <div class="space-y-4 mb-6">
            <h3 class="text-lg font-semibold text-white/90">Project Details</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Project Name</label>
                    <input type="text" id="projectName" class="form-input" placeholder="Conference Room Alpha" value="Enhanced AV Conference Room">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Client Name</label>
                    <input type="text" id="clientName" class="form-input" placeholder="Acme Corporation" value="Premium Enterprise Client">
                </div>
            </div>
        </div>

        <div class="space-y-4 mb-6">
            <h3 class="text-lg font-semibold text-white/90">Room Configuration</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-center">Width (m)</label>
                    <input type="number" id="roomWidth" class="form-input text-center" value="8" min="3" max="25" step="0.5">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-center">Depth (m)</label>
                    <input type="number" id="roomDepth" class="form-input text-center" value="6" min="3" max="25" step="0.5">
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Room Capacity</label>
                    <select id="roomSize" class="form-select">
                        <option value="small">Small (2-6 people)</option>
                        <option value="medium" selected>Medium (6-12 people)</option>
                        <option value="large">Large (12-20 people)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Primary Use Case</label>
                    <select id="useCase" class="form-select">
                        <option value="meeting_room">Meeting Room</option>
                        <option value="boardroom" selected>Executive Boardroom</option>
                        <option value="huddle_room">Huddle Space</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Quality Tier</label>
                    <select id="budgetRange" class="form-select">
                        <option value="economy">Economy</option>
                        <option value="standard" selected>Standard Professional</option>
                        <option value="premium">Premium Enterprise</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button id="updateRoom" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:opacity-80 text-white font-semibold py-3 px-4 rounded-lg transition-opacity">Update Room</button>
                <button id="generateFullBoq" class="bg-gradient-to-r from-green-600 to-blue-600 hover:opacity-80 text-white font-semibold py-3 px-4 rounded-lg transition-opacity">ü§ñ AI Generate</button>
            </div>
        </div>
        
        <div class="space-y-4 mb-6">
            <h3 class="text-lg font-semibold text-white/90">Special Requirements</h3>
            <textarea id="requirements" class="form-input h-24 resize-none" placeholder="e.g., wireless presentation, specific brand...">Seamless hybrid meeting experience with 4K displays and intuitive room controls.</textarea>
        </div>
    </div>
    
    <div class="boq-panel premium-glass rounded-2xl p-6 virtual-scroll">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">üìã Bill of Quantities</h2>
            <div class="flex space-x-2">
                <button id="exportBoq" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-all">Export</button>
                <button id="clearBoq" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-all">Clear</button>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-black/20 rounded-lg border border-white/10">
            <div class="text-sm font-semibold text-blue-200 mb-2">Project Summary</div>
            <div id="projectSummary" class="text-xs text-white/80 space-y-1">
                <div>Room: <span id="summaryDimensions">8m √ó 6m</span></div>
                <div>Capacity: <span id="summaryCapacity">Medium (6-12 people)</span></div>
                <div>Type: <span id="summaryType">Executive Boardroom</span></div>
                <div>Tier: <span id="summaryTier">Standard Professional</span></div>
            </div>
        </div>
        
        <div id="boqContainer" class="space-y-4">
            </div>
        
        <div id="totalSummary" class="mt-6 p-4 bg-black/20 rounded-lg border border-green-500/30">
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold text-green-300">Total Project Value:</span>
                <span id="totalCost" class="text-xl font-bold text-white">$0.00</span>
            </div>
            <div class="text-xs text-white/60 mt-2">
                <div class="flex justify-between">
                    <span>Equipment:</span>
                    <span id="equipmentCost">$0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Installation (Est. 20%):</span>
                    <span id="installationCost">$0.00</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Main application instance
        let designer;

        class Enhanced3DRoomDesigner {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.room = null;
                this.boqData = {};
                this.roomDimensions = { width: 8, depth: 6, height: 3 };
                
                // --- BACKEND CONNECTION ---
                this.backendUrl = 'https://adarshav-boq-backend.hf.space';

                this.init();
                this.setupEventListeners();
                this.updateProjectSummary();
                this.updateBOQDisplay(); // Initial render
            }
            
            init() {
                try {
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x0a0a1a);
                    
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.camera.position.set(10, 8, 10);
                    this.camera.lookAt(0, 0, 0);
                    
                    this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    
                    document.getElementById('renderContainer').appendChild(this.renderer.domElement);
                    
                    this.setupLighting();
                    this.createRoom();
                    this.setupControls();
                    this.animate();
                } catch (error) {
                    console.error('Failed to initialize 3D scene:', error);
                    this.showToast('Error loading 3D canvas', 'error');
                }
            }
            
            setupLighting() {
                this.scene.add(new THREE.AmbientLight(0x404040, 0.5));
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(10, 15, 5);
                dirLight.castShadow = true;
                this.scene.add(dirLight);
            }

            createRoom() {
                if (this.room) this.scene.remove(this.room);
                this.room = new THREE.Group();
                
                const floor = new THREE.Mesh(
                    new THREE.PlaneGeometry(this.roomDimensions.width, this.roomDimensions.depth),
                    new THREE.MeshLambertMaterial({ color: 0x2a2a3a })
                );
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.room.add(floor);
                this.scene.add(this.room);
            }

            setupControls() {
                // Simplified manual orbit controls
                const canvas = this.renderer.domElement;
                let isMouseDown = false, mouseX = 0, mouseY = 0;

                const onPointerDown = (e) => { isMouseDown = true; mouseX = e.clientX; mouseY = e.clientY; };
                const onPointerUp = () => { isMouseDown = false; };
                const onPointerMove = (e) => {
                    if (!isMouseDown) return;
                    const deltaX = e.clientX - mouseX, deltaY = e.clientY - mouseY;
                    const spherical = new THREE.Spherical().setFromVector3(this.camera.position);
                    spherical.theta -= deltaX * 0.005;
                    spherical.phi = Math.max(0.1, Math.min(Math.PI / 2, spherical.phi - deltaY * 0.005));
                    this.camera.position.setFromSpherical(spherical);
                    this.camera.lookAt(0, 0, 0);
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                };
                const onWheel = (e) => {
                    this.camera.position.multiplyScalar(e.deltaY > 0 ? 1.1 : 0.9);
                };

                canvas.addEventListener('pointerdown', onPointerDown);
                canvas.addEventListener('pointerup', onPointerUp);
                canvas.addEventListener('pointermove', onPointerMove);
                canvas.addEventListener('wheel', onWheel);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.renderer.render(this.scene, this.camera);
            }
            
            setupEventListeners() {
                document.getElementById('updateRoom').addEventListener('click', () => this.updateRoomDimensions());
                document.getElementById('generateFullBoq').addEventListener('click', () => this.generateAIBoq());
                document.getElementById('exportBoq').addEventListener('click', () => this.exportBoq());
                document.getElementById('clearBoq').addEventListener('click', () => this.clearBoq());

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            updateRoomDimensions() {
                this.roomDimensions.width = parseFloat(document.getElementById('roomWidth').value);
                this.roomDimensions.depth = parseFloat(document.getElementById('roomDepth').value);
                this.createRoom();
                this.updateProjectSummary();
                this.showToast('Room dimensions updated!', 'success');
            }

            async generateAIBoq() {
                this.showLoadingOverlay(true);

                const roomConfig = {
                    width: this.roomDimensions.width,
                    depth: this.roomDimensions.depth,
                    height: this.roomDimensions.height,
                    capacity: document.getElementById('roomSize').value,
                    useCase: document.getElementById('useCase').value,
                    budgetTier: document.getElementById('budgetRange').value,
                    requirements: document.getElementById('requirements').value,
                };
                
                try {
                    // --- REAL BACKEND API CALL ---
                    console.log('Sending data to backend:', roomConfig);
                    const response = await fetch(`${this.backendUrl}/generate_boq`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(roomConfig)
                    });

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.status} ${response.statusText}`);
                    }

                    const generatedBoq = await response.json();
                    console.log('Received BOQ from backend:', generatedBoq);
                    
                    // Assuming the backend returns the BOQ in the correct format { "Category": [items] }
                    this.boqData = generatedBoq.boq; 
                    
                    this.updateBOQDisplay();
                    this.showToast('AI-powered BOQ generated successfully!', 'success');

                } catch (error) {
                    console.error('Error fetching from backend:', error);
                    this.showToast('Backend connection failed. Using offline mode.', 'error');
                    this.generateOfflineBoq(roomConfig); // Fallback to offline mode
                } finally {
                    this.showLoadingOverlay(false);
                }
            }

            generateOfflineBoq(config) {
                // This is a simple client-side fallback if the backend fails
                this.boqData = {};
                this.addItemToBOQ('Displays & Projectors', 'Interactive 86" 4K Display', 4500, 1);
                this.addItemToBOQ('UC & Collaboration Devices', 'Logitech Rally Bar', 2700, 1);
                this.addItemToBOQ('UC & Collaboration Devices', 'Logitech Tap IP', 1200, 1);
                this.updateBOQDisplay();
            }

            addItemToBOQ(category, name, price, quantity) {
                if (!this.boqData[category]) this.boqData[category] = [];
                const existingItem = this.boqData[category].find(item => item.name === name);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    this.boqData[category].push({ name, price, quantity, unitPrice: price });
                }
            }
            
            updateBOQDisplay() {
                const container = document.getElementById('boqContainer');
                container.innerHTML = '';
                let totalEquipmentCost = 0;

                if (Object.keys(this.boqData).length === 0) {
                    container.innerHTML = `<div class="text-center text-sm text-white/60 p-4">Your BOQ is empty. Click "AI Generate" to start.</div>`;
                }

                Object.entries(this.boqData).forEach(([category, items]) => {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'boq-section';
                    categorySection.innerHTML = `<h3 class="text-lg font-semibold text-white/90 mb-3">${category}</h3>`;
                    
                    items.forEach((item, index) => {
                        const itemCost = item.price * item.quantity;
                        totalEquipmentCost += itemCost;
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'boq-item';
                        itemDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm">${item.name}</div>
                                    <div class="text-xs text-white/80 mt-1">
                                        Qty: ${item.quantity} √ó $${item.unitPrice.toLocaleString()} = $${itemCost.toLocaleString()}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <button onclick="designer.adjustQuantity('${category}', ${index}, -1)" class="px-2 py-1 bg-red-600/20 hover:bg-red-600/40 text-red-300 text-xs rounded">-</button>
                                    <button onclick="designer.removeItem('${category}', ${index})" class="px-2 py-1 bg-red-600/20 hover:bg-red-600/40 text-red-300 text-xs rounded">√ó</button>
                                </div>
                            </div>`;
                        categorySection.appendChild(itemDiv);
                    });
                    container.appendChild(categorySection);
                });
                
                const installationCost = totalEquipmentCost * 0.20;
                document.getElementById('equipmentCost').textContent = `$${totalEquipmentCost.toLocaleString()}`;
                document.getElementById('installationCost').textContent = `$${installationCost.toLocaleString()}`;
                document.getElementById('totalCost').textContent = `$${(totalEquipmentCost + installationCost).toLocaleString()}`;
            }
            
            adjustQuantity(category, index, change) {
                const item = this.boqData[category]?.[index];
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) this.boqData[category].splice(index, 1);
                    this.updateBOQDisplay();
                }
            }
            
            removeItem(category, index) {
                if (this.boqData[category]?.[index]) {
                    this.boqData[category].splice(index, 1);
                    this.updateBOQDisplay();
                    this.showToast('Item removed', 'success');
                }
            }

            exportBoq() {
                let csvContent = "Category,Item,Quantity,Unit Price,Total Price\n";
                Object.entries(this.boqData).forEach(([category, items]) => {
                    items.forEach(item => {
                        csvContent += `"${category}","${item.name}",${item.quantity},${item.unitPrice},${item.price * item.quantity}\n`;
                    });
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "BOQ_Export.csv";
                link.click();
                URL.revokeObjectURL(link.href);
                this.showToast('BOQ exported as CSV!', 'success');
            }
            
            clearBoq() {
                if (confirm('Are you sure you want to clear the entire BOQ?')) {
                    this.boqData = {};
                    this.updateBOQDisplay();
                    this.showToast('BOQ cleared!', 'success');
                }
            }

            updateProjectSummary() {
                document.getElementById('summaryDimensions').textContent = `${document.getElementById('roomWidth').value}m √ó ${document.getElementById('roomDepth').value}m`;
                document.getElementById('summaryCapacity').textContent = document.getElementById('roomSize').options[document.getElementById('roomSize').selectedIndex].text;
                document.getElementById('summaryType').textContent = document.getElementById('useCase').options[document.getElementById('useCase').selectedIndex].text;
                document.getElementById('summaryTier').textContent = document.getElementById('budgetRange').options[document.getElementById('budgetRange').selectedIndex].text;
            }
            
            showLoadingOverlay(show) {
                document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
            }
            
            showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                const style = type === 'success' 
                    ? 'from-green-500 to-blue-500' 
                    : 'from-red-500 to-orange-500';
                
                toast.className = `toast premium-glass p-4 bg-gradient-to-r ${style} text-white shadow-lg`;
                toast.innerHTML = `<div class="font-medium">${message}</div>`;
                
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            designer = new Enhanced3DRoomDesigner();
        });
    </script>
</body>
</html>

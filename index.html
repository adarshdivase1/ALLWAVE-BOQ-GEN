<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced 3D AV Room Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DragControls.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: rgba(255, 255, 255, 0.15); --accent-blue: #3b82f6; --accent-purple: #8b5cf6; --success-green: #10b981; --error-red: #ef4444; } body { font-family: 'Inter', sans-serif; background: var(--primary-gradient); min-height: 100vh; color: white; overflow: hidden; margin: 0; padding: 0; } .premium-glass { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3); } .control-panel, .boq-panel { position: fixed; top: 20px; z-index: 100; max-width: 420px; max-height: calc(100vh - 40px); overflow-y: auto; } .control-panel { left: 20px; } .boq-panel { right: 20px; max-width: 480px; } .mini-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; max-width: 600px; } .equipment-item { cursor: grab; transition: all 0.3s ease; border: 2px solid transparent; position: relative; overflow: hidden; } .equipment-item:hover { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); } .equipment-item:active { cursor: grabbing; transform: scale(0.98); } .form-input, .form-select { width: 100%; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 8px !important; padding: 12px 16px !important; color: white !important; font-size: 1rem; transition: all 0.3s ease; } .form-input:focus, .form-select:focus { border-color: var(--accent-blue) !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important; outline: none !important; } .form-select option { background: #1a1a2e; } .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); z-index: 1000; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); opacity: 0; } .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; } .virtual-scroll::-webkit-scrollbar { width: 8px; } .virtual-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 8px; } .virtual-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 8px; } .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid white; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } #renderContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; cursor: grab; } #renderContainer:active { cursor: grabbing; } .view-controls { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; } .view-btn { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease; } .view-btn:hover { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); transform: translateY(-2px); } .category-header { font-weight: 600; margin: 16px 0 8px 0; padding: 8px; border-radius: 6px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="toastContainer"></div><div id="connectionStatus" class="connection-status status-offline">üîÑ Checking Backend Connection...</div><div id="loadingOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center z-50 hidden"><div class="loading-spinner mb-4"></div><div class="text-white text-lg font-semibold">Generating AI-Powered BOQ...</div><div class="text-white/70 text-sm mt-2">Analyzing room dimensions and requirements</div></div><div id="renderContainer"></div><div class="view-controls"><button class="view-btn" id="topView" title="Top View">üìê</button><button class="view-btn" id="frontView" title="Front View">üëÅÔ∏è</button><button class="view-btn" id="isoView" title="Isometric View">üéØ</button><button class="view-btn" id="resetView" title="Reset View">üîÑ</button></div><div class="mini-panel premium-glass rounded-xl p-4"><div class="flex items-center justify-between space-x-4"><div class="flex items-center space-x-3"><div class="text-sm font-semibold text-blue-300">Quick Actions:</div><button id="quickGenerate" class="px-4 py-2 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">ü§ñ AI Generate</button><button id="togglePanels" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">üìä Toggle Panels</button></div><div class="text-xs text-white/60"><span id="quickStats">Room: 8m√ó6m | Items: 0 | Total: $0</span></div></div></div><div id="controlPanel" class="control-panel premium-glass rounded-2xl p-6 virtual-scroll"><h2 class="text-xl font-bold mb-4 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">üèóÔ∏è Room Designer Pro</h2><div class="space-y-4 mb-6"><h3 class="text-lg font-semibold text-white/90">Project Details</h3><div class="space-y-3"><div><label class="block text-sm font-medium mb-1">Project Name</label><input type="text" id="projectName" class="form-input" placeholder="Conference Room Alpha" value="Enhanced AV Conference Room"></div><div><label class="block text-sm font-medium mb-1">Client Name</label><input type="text" id="clientName" class="form-input" placeholder="Acme Corporation" value="Premium Enterprise Client"></div></div></div><div class="space-y-4 mb-6"><h3 class="text-lg font-semibold text-white/90">Room Configuration</h3><div class="room-controls"><div><input type="number" id="roomWidth" class="form-input text-center" placeholder="Width (m)" value="8" min="3" max="25" step="0.5"><small class="text-xs text-white/60">Width (m)</small></div><div><input type="number" id="roomDepth" class="form-input text-center" placeholder="Depth (m)" value="6" min="3" max="25" step="0.5"><small class="text-xs text-white/60">Depth (m)</small></div></div><div class="grid grid-cols-1 gap-3"><div><label class="block text-sm font-medium mb-1">Room Capacity</label><select id="roomSize" class="form-select"><option value="small">Small (2-6 people)</option><option value="medium" selected>Medium (6-12 people)</option><option value="large">Large (12-20 people)</option><option value="xlarge">Extra Large (20-50 people)</option><option value="auditorium">Auditorium (50+ people)</option></select></div><div><label class="block text-sm font-medium mb-1">Primary Use Case</label><select id="useCase" class="form-select"><option value="meeting_room">Meeting Room</option><option value="boardroom" selected>Executive Boardroom</option><option value="huddle_room">Huddle Space</option><option value="training">Training Room</option><option value="auditorium">Auditorium</option></select></div><div><label class="block text-sm font-medium mb-1">Quality Tier</label><select id="budgetRange" class="form-select"><option value="economy">Economy Tier</option><option value="standard" selected>Standard Professional</option><option value="premium">Premium Enterprise</option><option value="enterprise">Ultra High-End</option></select></div><div><label class="block text-sm font-medium mb-1">Brand Preference</label><select id="brandPreference" class="form-select"><option value="">No Preference</option><option value="logitech">Logitech</option><option value="poly">Poly</option><option value="cisco">Cisco</option></select></div></div><div class="grid grid-cols-2 gap-3 mt-4"><button id="updateRoom" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-lg">Update Room</button><button id="generateFullBoq" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-lg">ü§ñ AI Generate</button></div></div><div class="space-y-4 mb-6"><h3 class="text-lg font-semibold text-white/90">Special Requirements</h3><textarea id="requirements" class="form-input h-24 resize-none" placeholder="Describe special requirements...">Seamless hybrid meeting experience with wireless presentation, 4K displays, advanced audio processing, and intuitive room controls</textarea></div><div><h3 class="text-lg font-semibold mb-3 text-white/90">Equipment Library</h3><div class="mb-3"><input type="text" id="equipmentSearch" class="form-input" placeholder="Search equipment..."></div><div id="equipmentLibrary" class="space-y-2 max-h-64 overflow-y-auto virtual-scroll"><div class="text-center py-8 text-white/60"><div class="loading-spinner mb-4 mx-auto"></div><div class="text-sm">Loading equipment library...</div></div></div></div></div><div id="boqPanel" class="boq-panel premium-glass rounded-2xl p-6 virtual-scroll"><div class="flex items-center justify-between mb-4"><h2 class="text-xl font-bold bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">üìã Bill of Quantities</h2><div class="flex space-x-2"><button id="exportBoq" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">Export</button><button id="clearBoq" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg">Clear</button></div></div><div class="mb-6 p-4 bg-gradient-to-r from-blue-500/20 to-green-500/20 rounded-lg border border-blue-500/30"><div class="text-sm font-semibold text-blue-200 mb-2">Project Summary</div><div id="projectSummary" class="text-xs text-white/80 space-y-1"><div>Room: <span id="summaryDimensions">8m √ó 6m</span></div><div>Capacity: <span id="summaryCapacity">Medium (6-12 people)</span></div><div>Type: <span id="summaryType">Executive Boardroom</span></div><div>Tier: <span id="summaryTier">Standard Professional</span></div></div></div><div class="analytics-panel mb-6"><div class="text-sm font-semibold text-purple-200 mb-2">üìä Room Analytics</div><div id="analyticsContent" class="text-xs text-white/80 space-y-2"><div class="flex justify-between"><span>Room Area:</span><span id="roomArea" class="font-mono">48m¬≤</span></div><div class="flex justify-between"><span>Complexity Score:</span><span id="complexityScore" class="font-mono">5/10</span></div><div class="flex justify-between"><span>Acoustic Rating:</span><span id="acousticRating" class="font-mono">Good</span></div></div></div><div id="boqContent"><div class="text-center py-8 text-white/60"><div class="text-4xl mb-2">üì¶</div><div class="text-sm">No equipment added yet</div><div class="text-xs mt-1">Click items from the library or use AI Generate</div></div></div><div id="recommendationsSection" class="recommendations hidden"><div class="text-sm font-semibold text-green-200 mb-2">üí° AI Recommendations</div><div id="recommendationsContent" class="text-xs text-white/80"></div></div><div class="mt-6 p-4 bg-gradient-to-r from-green-500/20 to-blue-500/20 rounded-lg border border-green-500/30"><div class="flex justify-between items-center"><div><div class="text-sm font-semibold text-green-200">Total Investment</div></div><div class="text-right"><div id="totalCost" class="text-xl font-bold text-green-300">$0</div><div id="totalItems" class="text-xs text-white/60">0 items</div></div></div></div></div>
<script>
    // --- GLOBAL VARIABLES ---
    let scene, camera, renderer, orbitControls, dragControls;
    let room, gridHelper, roomWidth = 8, roomDepth = 6, roomHeight = 3;
    let boqData = null;
    let allProducts = []; // This will now store the lightweight product list
    let panelsVisible = true;
    
    let draggableObjects = [];
    let selectedObject = null;
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    // --- CONFIGURATION ---
    const API_BASE_URL = 'https://adarshav-boq-backend.hf.space';
    
    // (The equipmentVisualization object is unchanged)
    const equipmentVisualization = { 'Displays & Projectors': { geometry: () => new THREE.BoxGeometry(2.2, 1.25, 0.1), material: () => new THREE.MeshStandardMaterial({ color: 0x2c3e50, roughness: 0.7 }), position: [0, 1.5, -3.9] }, 'UC & Collaboration Devices': { geometry: () => new THREE.BoxGeometry(0.8, 0.15, 0.2), material: () => new THREE.MeshStandardMaterial({ color: 0x1abc9c, roughness: 0.5 }), position: [0, 0.8, 0] }, 'Audio: Speakers & Amplifiers': { geometry: () => new THREE.CylinderGeometry(0.15, 0.15, 0.3, 16), material: () => new THREE.MeshStandardMaterial({ color: 0xe67e22, roughness: 0.6 }), position: [3.5, 2.8, 0] }, 'Audio: Microphones & Conferencing': { geometry: () => new THREE.CylinderGeometry(0.1, 0.1, 0.05, 16), material: () => new THREE.MeshStandardMaterial({ color: 0xf39c12, roughness: 0.4 }), position: [0, 0.75, 0] }, 'Control & Processing': { geometry: () => new THREE.BoxGeometry(0.5, 0.2, 0.4), material: () => new THREE.MeshStandardMaterial({ color: 0x8e44ad, roughness: 0.8 }), position: [0, 0.1, 2.7] }, 'default': { geometry: () => new THREE.BoxGeometry(0.4, 0.4, 0.4), material: () => new THREE.MeshStandardMaterial({ color: 0x95a5a6, roughness: 0.8 }), position: [0, 0.2, 0] } };

    // --- INITIALIZATION ---
    function init() {
        checkBackendConnection();
        setupScene();
        setupControls();
        setupEventListeners();
        createRoom();
        loadEquipmentLibrary(); // This is now much faster
        updateQuickStats();
    }

    async function checkBackendConnection() {
        const status = document.getElementById('connectionStatus');
        try {
            const response = await fetch(`${API_BASE_URL}/api/health`);
            if (response.ok) {
                const data = await response.json();
                status.className = 'connection-status status-online';
                status.innerHTML = `‚úÖ BACKEND ONLINE (${data.product_count} PRODUCTS)`;
            } else { throw new Error('Connection failed'); }
        } catch (error) {
            status.className = 'connection-status status-offline';
            status.innerHTML = '‚ùå BACKEND OFFLINE - DEMO MODE';
        }
    }

    // --- THREE.JS SETUP (Unchanged) ---
    function setupScene() { const container = document.getElementById('renderContainer'); scene = new THREE.Scene(); scene.background = new THREE.Color(0x0a0a0a); scene.fog = new THREE.Fog(0x0a0a0a, 15, 40); camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.set(8 * 0.8, 3 * 1.5, 6 * 1.2); renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true; renderer.setClearColor(0x000000, 0); container.appendChild(renderer.domElement); const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); scene.add(ambientLight); const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(10, 15, 5); dirLight.castShadow = true; scene.add(dirLight); window.addEventListener('resize', onWindowResize, false); animate(); }
    function setupControls() { orbitControls = new THREE.OrbitControls(camera, renderer.domElement); orbitControls.enableDamping = true; orbitControls.maxPolarAngle = Math.PI / 2.1; orbitControls.target.set(0, 1, 0); dragControls = new THREE.DragControls(draggableObjects, camera, renderer.domElement); dragControls.addEventListener('dragstart', () => orbitControls.enabled = false); dragControls.addEventListener('dragend', () => orbitControls.enabled = true); dragControls.addEventListener('drag', (e) => { e.object.position.y = e.object.geometry.parameters.height / 2 || 0.2; }); }
    function createRoom() { if (room) scene.remove(room); if (gridHelper) scene.remove(gridHelper); room = new THREE.Group(); const floor = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomDepth), new THREE.MeshStandardMaterial({ color: 0x2c3e50 })); floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true; room.add(floor); const walls = new THREE.Mesh(new THREE.BoxGeometry(roomWidth, roomHeight, roomDepth), new THREE.MeshStandardMaterial({ color: 0x34495e, transparent: true, opacity: 0.2, side: THREE.DoubleSide })); walls.position.y = roomHeight / 2; room.add(walls); const wireframe = new THREE.LineSegments(new THREE.EdgesGeometry(walls.geometry), new THREE.LineBasicMaterial({ color: 0x3b82f6, opacity: 0.5, transparent: true })); wireframe.position.y = roomHeight / 2; room.add(wireframe); scene.add(room); gridHelper = new THREE.GridHelper(Math.max(roomWidth, roomDepth) * 2, 40, 0x444444, 0x444444); gridHelper.position.y = 0.01; scene.add(gridHelper); updateAnalytics(); }
    
    // --- CORE LOGIC ---

    async function loadEquipmentLibrary() {
        try {
            // UPDATED: Call the new, fast endpoint
            const response = await fetch(`${API_BASE_URL}/api/products/library`);
            if (response.ok) {
                allProducts = await response.json(); // Store the lightweight list
                displayEquipmentLibrary(allProducts);
            } else {
                throw new Error('Backend unavailable for library');
            }
        } catch (error) {
            console.error('Could not fetch equipment library:', error);
            const library = document.getElementById('equipmentLibrary');
            library.innerHTML = `<div class="text-center p-4 text-white/60">Failed to load equipment.</div>`;
            showToast('Could not load equipment library', 'error');
        }
    }
    
    // All other JavaScript functions (displayEquipmentLibrary, addProductToBoq, generateFullBoq, etc.)
    // are the same as the previous correct version. No changes needed in their logic.
    // ... [Omitted for brevity] ...
    function displayEquipmentLibrary(products) { const library = document.getElementById('equipmentLibrary'); library.innerHTML = ''; if (!products.length) { library.innerHTML = `<div class="text-center p-4 text-white/60">No matching equipment.</div>`; return; } const categories = products.reduce((acc, p) => { (acc[p.category] = acc[p.category] || []).push(p); return acc; }, {}); Object.keys(categories).sort().forEach(cat => { const header = document.createElement('div'); header.className = 'category-header bg-gradient-to-r from-blue-600/20 to-purple-600/20 text-blue-200'; header.textContent = cat; library.appendChild(header); categories[cat].forEach(p => library.appendChild(createEquipmentItem(p))); }); }
    function createEquipmentItem(product) { const div = document.createElement('div'); div.className = 'equipment-item premium-glass rounded-lg p-3'; div.dataset.productId = product.id; div.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1 pr-2"><div class="font-semibold text-sm text-white">${product.name}</div><div class="text-xs text-white/60 mt-1">${product.brand} ${product.model || ''}</div></div><div class="text-right"><div class="font-bold text-green-400">$${product.price?.toLocaleString() || 'N/A'}</div></div></div>`; div.addEventListener('click', () => { addProductToBoq(product); add3DEquipment(product); showToast(`Added ${product.name}`, 'success'); }); return div; }
    function addProductToBoq(product, quantity = 1) { if (!boqData) boqData = { categories: {} }; const cat = product.category; if (!boqData.categories[cat]) boqData.categories[cat] = { items: [] }; const existing = boqData.categories[cat].items.find(i => i.id === product.id); if (existing) { existing.quantity += quantity; existing.total_price = existing.quantity * existing.unit_price; } else { boqData.categories[cat].items.push({ id: product.id, name: product.name, brand: product.brand, model: product.model || '', unit_price: product.price || 0, quantity: quantity, total_price: (product.price || 0) * quantity, category: cat }); } updateBoqDisplay(); updateQuickStats(); }
    function add3DEquipment(product, isBulkAdd = false) { const config = equipmentVisualization[product.category] || equipmentVisualization['default']; const equipment = new THREE.Mesh(config.geometry(), config.material()); const pos = config.position; equipment.position.set(isBulkAdd ? pos[0] : (Math.random() - 0.5) * (roomWidth * 0.5), equipment.geometry.parameters.height / 2 || 0.2, isBulkAdd ? pos[2] : (Math.random() - 0.5) * (roomDepth * 0.5)); equipment.castShadow = true; equipment.userData = { product }; scene.add(equipment); draggableObjects.push(equipment); }
    function updateBoqDisplay() { const boqContent = document.getElementById('boqContent'); if (!boqData || Object.keys(boqData.categories).length === 0) { boqContent.innerHTML = `<div class="text-center py-8 text-white/60"><div class="text-4xl mb-2">üì¶</div><div class="text-sm">No equipment added yet</div></div>`; document.getElementById('totalCost').textContent = '$0'; document.getElementById('totalItems').textContent = '0 items'; return; } let html = ''; let totalCost = 0, totalItems = 0; Object.entries(boqData.categories).forEach(([cat, data]) => { html += `<div class="boq-section"><h4 class="text-sm font-semibold text-blue-300 mb-2">${cat}</h4>`; data.items.forEach(item => { totalCost += item.total_price; totalItems += item.quantity; html += `<div class="boq-item"><div class="flex justify-between items-start"><div class="flex-1"><div class="text-sm font-medium">${item.name}</div><div class="text-xs text-white/60">${item.brand} ${item.model}</div><div class="text-xs text-white/50 mt-1">Qty: ${item.quantity} √ó $${item.unit_price.toLocaleString()}</div></div><div class="text-right"><div class="font-bold text-green-400">$${item.total_price.toLocaleString()}</div><button class="text-xs text-red-400 hover:text-red-300 mt-1" onclick="removeBoqItemById(${item.id})">Remove</button></div></div></div>`; }); html += `</div>`; }); boqContent.innerHTML = html; document.getElementById('totalCost').textContent = `$${totalCost.toLocaleString()}`; document.getElementById('totalItems').textContent = `${totalItems} items`; }
    function removeBoqItemById(itemId, quantity = 1, fromScene = false) { if (!boqData) return; let item, cat, index; for (const c in boqData.categories) { const i = boqData.categories[c].items.findIndex(it => it.id === itemId); if (i > -1) { item = boqData.categories[c].items[i]; cat = c; index = i; break; } } if (item) { if (fromScene || item.quantity <= quantity) { boqData.categories[cat].items.splice(index, 1); } else { item.quantity -= quantity; item.total_price = item.quantity * item.unit_price; } if (boqData.categories[cat].items.length === 0) delete boqData.categories[cat]; updateBoqDisplay(); updateQuickStats(); if (!fromScene) showToast('Item removed', 'success'); } }
    async function generateFullBoq() { const overlay = document.getElementById('loadingOverlay'); overlay.classList.remove('hidden'); clearBoq(true); try { const reqData = { projectName: document.getElementById('projectName').value, clientName: document.getElementById('clientName').value, room_dimensions: [parseFloat(document.getElementById('roomWidth').value), parseFloat(document.getElementById('roomDepth').value), roomHeight], roomSize: document.getElementById('roomSize').value, useCase: document.getElementById('useCase').value, brandPreference: document.getElementById('brandPreference').value, requirements: document.getElementById('requirements').value, budgetRange: document.getElementById('budgetRange').value, }; const response = await fetch(`${API_BASE_URL}/api/generate-boq`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reqData) }); if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`); const data = await response.json(); if (data.status === 'success') { boqData = { categories: data.boq.categories || {} }; updateBoqDisplay(); updateQuickStats(); if (data.boq.recommendations) { const recSection = document.getElementById('recommendationsSection'); recSection.querySelector('#recommendationsContent').innerHTML = data.boq.recommendations.join('<br>‚Ä¢ '); recSection.classList.remove('hidden'); } Object.values(boqData.categories).forEach(cat => { cat.items.forEach(item => { const pInfo = allProducts.find(p => p.id === item.productId) || item; add3DEquipment({ ...pInfo, category: item.category }, true); }); }); showToast('‚úÖ AI BOQ Generated!', 'success'); } else { throw new Error(data.message || 'Failed to generate BOQ'); } } catch (error) { console.error('Error generating BOQ:', error); showToast('‚ö†Ô∏è Could not generate BOQ. Using demo data.', 'warning'); } finally { overlay.classList.add('hidden'); } }
    function setupEventListeners() { document.getElementById('updateRoom').addEventListener('click', () => { roomWidth = parseFloat(document.getElementById('roomWidth').value); roomDepth = parseFloat(document.getElementById('roomDepth').value); createRoom(); updateProjectSummary(); updateQuickStats(); }); document.getElementById('generateFullBoq').addEventListener('click', generateFullBoq); document.getElementById('quickGenerate').addEventListener('click', generateFullBoq); document.getElementById('exportBoq').addEventListener('click', () => {}); document.getElementById('clearBoq').addEventListener('click', () => clearBoq(false)); document.getElementById('togglePanels').addEventListener('click', () => { panelsVisible = !panelsVisible; [document.getElementById('controlPanel'), document.getElementById('boqPanel')].forEach(p => p.style.display = panelsVisible ? 'block' : 'none'); }); document.getElementById('equipmentSearch').addEventListener('input', (e) => { const term = e.target.value.toLowerCase(); if (!term) { displayEquipmentLibrary(allProducts); return; } const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term) || p.brand.toLowerCase().includes(term) || p.category.toLowerCase().includes(term)); displayEquipmentLibrary(filtered); }); ['topView', 'frontView', 'isoView', 'resetView'].forEach(id => { document.getElementById(id).addEventListener('click', () => setCameraView(id)); }); ['roomSize', 'useCase', 'budgetRange'].forEach(id => document.getElementById(id).addEventListener('change', updateProjectSummary)); renderer.domElement.addEventListener('click', onObjectClick); window.addEventListener('keydown', onObjectDelete); updateProjectSummary(); }
    function onObjectClick(event) { mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = -(event.clientY / window.innerHeight) * 2 + 1; raycaster.setFromCamera(mouse, camera); const intersects = raycaster.intersectObjects(draggableObjects); if (selectedObject) selectedObject.material.emissive.setHex(0x000000); selectedObject = null; if (intersects.length > 0) { selectedObject = intersects[0].object; selectedObject.material.emissive.setHex(0x5555ff); } }
    function onObjectDelete(event) { if ((event.key === 'Delete' || event.key === 'Backspace') && selectedObject) { const pId = selectedObject.userData.product.id; scene.remove(selectedObject); const index = draggableObjects.indexOf(selectedObject); if (index > -1) draggableObjects.splice(index, 1); removeBoqItemById(pId, 1, true); selectedObject = null; showToast('Item removed', 'success'); } }
    function clearBoq(isSoft = false) { if (isSoft || confirm('Clear entire BOQ and room?')) { boqData = null; draggableObjects.forEach(obj => scene.remove(obj)); draggableObjects.length = 0; selectedObject = null; updateBoqDisplay(); updateQuickStats(); document.getElementById('recommendationsSection').classList.add('hidden'); if (!isSoft) showToast('BOQ cleared', 'success'); } }
    function updateProjectSummary() { document.getElementById('summaryDimensions').textContent = `${document.getElementById('roomWidth').value}m √ó ${document.getElementById('roomDepth').value}m`; document.getElementById('summaryCapacity').textContent = document.getElementById('roomSize').options[document.getElementById('roomSize').selectedIndex].text; document.getElementById('summaryType').textContent = document.getElementById('useCase').options[document.getElementById('useCase').selectedIndex].text; document.getElementById('summaryTier').textContent = document.getElementById('budgetRange').options[document.getElementById('budgetRange').selectedIndex].text; }
    function updateQuickStats() { const totalCost = boqData ? Object.values(boqData.categories).reduce((s, c) => s + c.items.reduce((iS, i) => iS + i.total_price, 0), 0) : 0; const totalItems = boqData ? Object.values(boqData.categories).reduce((s, c) => s + c.items.reduce((iS, i) => iS + i.quantity, 0), 0) : 0; document.getElementById('quickStats').textContent = `Room: ${roomWidth}m√ó${roomDepth}m | Items: ${totalItems} | Total: $${totalCost.toLocaleString()}`; }
    function updateAnalytics() { const area = roomWidth * roomDepth; document.getElementById('roomArea').textContent = `${area}m¬≤`; const items = draggableObjects.length; const complexity = Math.min(10, Math.floor((area / 15) + (items / 3))); document.getElementById('complexityScore').textContent = `${complexity}/10`; const acoustic = area > 60 ? 'Challenging' : area > 30 ? 'Good' : 'Basic'; document.getElementById('acousticRating').textContent = acoustic; }
    function setCameraView(view) { orbitControls.target.set(0, 1, 0); switch (view) { case 'topView': camera.position.set(0, 20, 0); break; case 'frontView': camera.position.set(0, 2, roomDepth); break; default: camera.position.set(roomWidth * 0.8, roomHeight * 1.5, roomDepth * 1.2); break; } }
    function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
    function animate() { requestAnimationFrame(animate); orbitControls.update(); renderer.render(scene, camera); }
    window.removeBoqItemById = removeBoqItemById; init();
</script>
</body>
</html>

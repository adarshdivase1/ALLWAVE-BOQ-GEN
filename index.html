<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced 3D AV Room Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --success-green: #10b981;
            --error-red: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--primary-gradient); min-height: 100vh; color: white; overflow: hidden; margin: 0; padding: 0; }
        .premium-glass { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3); }
        .control-panel, .boq-panel { position: fixed; top: 20px; z-index: 100; max-width: 420px; max-height: calc(100vh - 40px); overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .control-panel { left: 20px; }
        .boq-panel { right: 20px; }
        .mini-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; max-width: 600px; }
        .equipment-item { cursor: grab; transition: all 0.3s ease; border: 2px solid transparent; position: relative; overflow: hidden; }
        .equipment-item:hover { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }
        .equipment-item:active { cursor: grabbing; transform: scale(0.98); }
        .form-input, .form-select { width: 100%; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 8px !important; padding: 12px 16px !important; color: white !important; font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus { border-color: var(--accent-blue) !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important; outline: none !important; }
        .form-select option { background: #1a1a2e; color: white; }
        .search-input { width: 100%; background: rgba(255, 255, 255, 0.08) !important; border: 1px solid rgba(59, 130, 246, 0.3) !important; border-radius: 12px !important; padding: 12px 16px 12px 40px !important; color: white !important; font-size: 0.9rem; margin-bottom: 16px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.5); font-size: 16px; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); z-index: 1000; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); opacity: 0; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .virtual-scroll::-webkit-scrollbar { width: 8px; }
        .virtual-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 8px; }
        .virtual-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 8px; }
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid white; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .boq-section { border-left: 4px solid var(--accent-blue); padding-left: 16px; margin-bottom: 20px; }
        .boq-item { background: rgba(255, 255, 255, 0.08); border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 3px solid var(--success-green); transition: all 0.3s ease; position: relative; }
        .boq-item:hover { background: rgba(255, 255, 255, 0.12); transform: translateX(4px); }
        #renderContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #renderContainer:active { cursor: grabbing; }
        .connection-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: opacity 0.5s ease; }
        .status-online { background: linear-gradient(45deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2)); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; }
        .status-offline { background: linear-gradient(45deg, rgba(239, 68, 68, 0.2), rgba(245, 158, 11, 0.2)); border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; }
        .analytics-panel { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 16px; margin-top: 16px; }
        .category-header { font-weight: 600; margin: 16px 0 8px 0; padding: 8px; border-radius: 6px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div id="toastContainer"></div>
    <div id="connectionStatus" class="connection-status status-offline">üîÑ Connecting to Backend...</div>
    <div id="loadingOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center z-50 hidden">
        <div class="loading-spinner mb-4"></div>
        <div class="text-white text-lg font-semibold">Generating AI-Powered BOQ...</div>
        <div class="text-white/70 text-sm mt-2">Contacting AV logic engine...</div>
    </div>
    <div id="renderContainer"><div id="dropZone" class="drop-zone"></div></div>
    <div class="view-controls" style="position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px;">
        <button id="topView" title="Top View" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease;">üîù</button>
        <button id="frontView" title="Front View" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease;">üè¢</button>
        <button id="isoView" title="Isometric View" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease;">üßä</button>
        <button id="resetView" title="Reset View" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease;">üîÑ</button>
    </div>
    <div class="mini-panel premium-glass rounded-xl p-4">
        <div class="flex items-center justify-between space-x-4">
            <div class="flex items-center space-x-3">
                <div class="text-sm font-semibold text-blue-300">Quick Actions:</div>
                <button id="quickGenerate" class="px-4 py-2 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">ü§ñ AI Generate</button>
                <button id="togglePanels" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">üìä Toggle Panels</button>
                <button id="loadRecommended" class="px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">‚≠ê Smart Load</button>
            </div>
            <div class="text-xs text-white/60"><span id="quickStats">Room: 8m√ó6m | Items: 0 | Total: $0</span></div>
        </div>
    </div>
    <div id="controlPanel" class="control-panel premium-glass rounded-2xl p-6 virtual-scroll">
        <h2 class="text-xl font-bold mb-4 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">üèóÔ∏è Room Designer Pro</h2>
        <div class="space-y-4 mb-6">
            <h3 class="text-lg font-semibold text-white/90">Project Details</h3>
            <div class="space-y-3">
                <div><label class="block text-sm font-medium mb-1">Project Name</label><input type="text" id="projectName" class="form-input" placeholder="Conference Room Alpha" value="Enhanced AV Conference Room"></div>
                <div><label class="block text-sm font-medium mb-1">Client Name</label><input type="text" id="clientName" class="form-input" placeholder="Acme Corporation" value="Premium Enterprise Client"></div>
            </div>
        </div>
        <div class="space-y-4 mb-6">
            <h3 class="text-lg font-semibold text-white/90">Quick Room Presets</h3>
            <div class="grid grid-cols-2 gap-3">
                <button class="room-preset-btn" data-preset="meeting"><div class="text-sm font-semibold">Meeting Room</div><div class="text-xs opacity-75">Standard setup</div></button>
                <button class="room-preset-btn" data-preset="boardroom"><div class="text-sm font-semibold">Boardroom</div><div class="text-xs opacity-75">Executive style</div></button>
                <button class="room-preset-btn" data-preset="auditorium"><div class="text-sm font-semibold">Auditorium</div><div class="text-xs opacity-75">Large venue</div></button>
                <button class="room-preset-btn" data-preset="huddle"><div class="text-sm font-semibold">Huddle Space</div><div class="text-xs opacity-75">Informal setup</div></button>
            </div>
        </div>
        <div class="space-y-4 mb-6">
            <h3 class="text-lg font-semibold text-white/90">Room Configuration</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div><input type="number" id="roomWidth" class="form-input text-center" placeholder="Width (m)" value="8" min="3" max="25" step="0.5"><small class="text-xs text-white/60">Width (m)</small></div>
                <div><input type="number" id="roomDepth" class="form-input text-center" placeholder="Depth (m)" value="6" min="3" max="25" step="0.5"><small class="text-xs text-white/60">Depth (m)</small></div>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Room Capacity</label>
                    <select id="roomSize" class="form-select">
                        <option value="small">Small (2-6 people)</option><option value="medium" selected>Medium (6-12 people)</option><option value="large">Large (12-20 people)</option><option value="xlarge">Extra Large (20-50 people)</option><option value="auditorium">Auditorium (50+ people)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Primary Use Case</label>
                    <select id="useCase" class="form-select">
                        <option value="meeting_room">Meeting Room</option><option value="boardroom" selected>Executive Boardroom</option><option value="huddle_room">Huddle Space</option><option value="training">Training Room</option><option value="presentation">Presentation Room</option><option value="auditorium">Auditorium</option><option value="classroom">Classroom</option><option value="webcast">Webcast Studio</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Quality Level</label>
                    <select id="qualityLevel" class="form-select">
                        <option value="economy">Economy</option><option value="standard">Standard</option><option value="premium" selected>Premium</option><option value="enterprise">Enterprise</option>
                    </select>
                </div>
            </div>
            <button id="updateRoom" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300">üîÑ Update Room</button>
        </div>
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-white/90">AV Equipment Library</h3>
            <div class="text-sm text-white/70 mb-3">Data loaded from the backend. Drag and drop to add.</div>
            <div class="relative"><div class="search-icon">üîç</div><input type="text" id="equipmentSearch" class="search-input" placeholder="Search equipment (e.g., camera, display, mic)..."></div>
            <div id="equipmentLibrary" class="space-y-2 max-h-96 overflow-y-auto virtual-scroll"></div>
        </div>
    </div>
    <div id="boqPanel" class="boq-panel premium-glass rounded-2xl p-6 virtual-scroll">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">üìä Bill of Quantities</h2>
            <div class="flex space-x-2">
                <button id="exportBOQ" class="px-3 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">üì§ Export</button>
                <button id="clearAll" class="px-3 py-2 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white text-sm font-semibold rounded-lg transition-all duration-300">üóëÔ∏è Clear</button>
            </div>
        </div>
        <div id="boqContent" class="space-y-4">
            <div class="text-center text-white/60 py-8"><div class="text-4xl mb-2">ü§ñ</div><div>Click "AI Generate" to build a BOQ</div><div class="text-sm mt-1">or drag items from the library</div></div>
        </div>
        <div class="analytics-panel">
            <h3 class="text-sm font-bold mb-3 text-purple-300">üìà Project Analytics</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><div class="text-white/60">Coverage Area</div><div id="coverageArea" class="text-white font-semibold">48 m¬≤</div></div>
                <div><div class="text-white/60">Equipment Count</div><div id="equipmentCount" class="text-white font-semibold">0 items</div></div>
                <div><div class="text-white/60">Install Time (Est.)</div><div id="installTime" class="text-white font-semibold">0 hours</div></div>
                <div><div class="text-white/60">Power (Est.)</div><div id="powerRequired" class="text-white font-semibold">0W</div></div>
            </div>
        </div>
        <div class="recommendations">
            <h3 class="text-sm font-bold mb-3 text-green-300">üí° Smart Recommendations</h3>
            <div id="recommendationsContent" class="text-sm text-white/80">AI recommendations from the backend will appear here.</div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION & GLOBAL VARIABLES ---
        const BACKEND_URL = 'https://adarshav-boq-backend.hf.space';
        let scene, camera, renderer, controls;
        let room = { width: 8, depth: 6, height: 3 };
        let placedEquipment = [];
        let raycaster, mouse;
        let panelsVisible = true;
        let selectedObject = null;
        let allEquipmentData = [];
        const TABLE_HEIGHT = 0.75;
        const equipmentSizeDatabase = {
            'default': { width: 0.5, height: 0.5, depth: 0.1, color: 0x555555 },
            'Displays & Projectors': { width: 1.45, height: 0.84, depth: 0.06, color: 0x1a1a1a },
            'UC & Collaboration Devices': { width: 0.9, height: 0.16, depth: 0.12, color: 0x333333 },
            'Audio: Microphones & Conferencing': { width: 0.6, height: 0.05, depth: 0.6, color: 0xf5f5f5 },
            'Audio: Speakers & Amplifiers': { width: 0.3, height: 0.15, depth: 0.3, color: 0xffffff },
            'Control & Processing': { width: 0.43, height: 0.044, depth: 0.25, color: 0x2a2a2a },
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            checkBackendConnection();
            initThreeJS();
            populateEquipmentLibrary();
            setupDragAndDrop();
            setupEventListeners();
        }

        async function checkBackendConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                if (!response.ok) throw new Error('Backend not responding');
                const data = await response.json();
                statusEl.className = 'connection-status status-online';
                statusEl.innerHTML = `‚úÖ Backend Connected (v${data.version})`;
                showToast(`Connected with ${data.product_count} products.`, 'success');
            } catch (error) {
                statusEl.className = 'connection-status status-offline';
                statusEl.innerHTML = `‚ùå Backend Disconnected`;
                showToast('Error connecting to backend. Please check console.', 'error');
                console.error("Backend connection error:", error);
            } finally {
                setTimeout(() => { if (statusEl) statusEl.style.opacity = '0'; }, 3000);
            }
        }

        // --- BACKEND INTEGRATION ---
        async function populateEquipmentLibrary() {
            const library = document.getElementById('equipmentLibrary');
            library.innerHTML = '<div class="loading-spinner mx-auto mt-8"></div>';
            try {
                const response = await fetch(`${BACKEND_URL}/api/products/library`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const products = await response.json();
                allEquipmentData = products;
                library.innerHTML = '';
                const categories = {};
                products.forEach(item => {
                    const categoryName = item.category || 'Uncategorized';
                    if (!categories[categoryName]) categories[categoryName] = [];
                    categories[categoryName].push(item);
                });
                Object.keys(categories).sort().forEach(categoryName => {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header';
                    categoryHeader.style.background = `linear-gradient(45deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2))`;
                    categoryHeader.innerHTML = `<span>${getCategoryIcon(categoryName)} ${categoryName}</span><span class="category-toggle">Show ${categories[categoryName].length}</span>`;
                    library.appendChild(categoryHeader);
                    const categoryItems = document.createElement('div');
                    categoryItems.className = 'category-items';
                    categories[categoryName].forEach(item => categoryItems.appendChild(createEquipmentItem(item)));
                    library.appendChild(categoryItems);
                });
            } catch (error) {
                console.error("Failed to fetch equipment library:", error);
                library.innerHTML = '<div class="text-red-400 p-4 text-center"><strong>Error:</strong> Could not load products from the backend. Please check the connection and try again.</div>';
            }
        }

        async function handleAIGenerateClick() {
            showLoading(true);
            clearAllEquipment(false);
            const roomConfig = {
                projectName: document.getElementById('projectName').value,
                clientName: document.getElementById('clientName').value,
                room_dimensions: [parseFloat(document.getElementById('roomWidth').value), parseFloat(document.getElementById('roomDepth').value), 3.0],
                roomSize: document.getElementById('roomSize').value,
                useCase: document.getElementById('useCase').value,
                budgetRange: document.getElementById('qualityLevel').value,
                requirements: ""
            };
            try {
                const response = await fetch(`${BACKEND_URL}/api/generate-boq`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roomConfig),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail?.message || 'BOQ Generation failed.');
                }
                const result = await response.json();
                renderBackendResponse(result);
                showToast('AI-Powered BOQ generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating BOQ:', error);
                showToast(`Error: ${error.message}`, 'error');
                document.getElementById('boqContent').innerHTML = `<div class="text-center text-red-400 py-8">BOQ Generation Failed.</div>`;
            } finally {
                showLoading(false);
            }
        }

        function renderBackendResponse(response) {
            if (!response || !response.boq) {
                console.error("Invalid response from backend:", response); return;
            }
            const boqData = response.boq;
            updateBoqPanelFromBackend(boqData);
            placeModelsFromBackend(boqData);
        }

        function updateBoqPanelFromBackend(boqData) {
            const boqContent = document.getElementById('boqContent');
            boqContent.innerHTML = '';
            let totalCost = 0;
            if (!boqData.categories || Object.keys(boqData.categories).length === 0) {
                boqContent.innerHTML = `<div class="text-center text-white/60 py-8">The AI could not generate a BOQ for these requirements.</div>`;
                return;
            }
            Object.entries(boqData.categories).forEach(([categoryName, categoryData]) => {
                const sectionTotal = categoryData.total_cost;
                totalCost += sectionTotal;
                let sectionHtml = `<div class="boq-section"><h3 class="text-lg font-semibold mb-3 text-blue-300">${getCategoryIcon(categoryName)} ${categoryName}<span class="float-right text-green-400">$${sectionTotal.toLocaleString()}</span></h3>`;
                categoryData.items.forEach(item => {
                    sectionHtml += `<div class="boq-item" data-product-id="${item.productId}">
                        <div class="font-semibold text-white">${item.name}</div>
                        <div class="text-sm text-blue-300">${item.brand}</div>
                        <div class="text-xs text-white/60 mt-1">
                            Qty: ${item.quantity} √ó $${item.unitPrice.toLocaleString()} = $${item.totalPrice.toLocaleString()}
                        </div>
                    </div>`;
                });
                sectionHtml += '</div>';
                boqContent.innerHTML += sectionHtml;
            });
            boqContent.innerHTML += `<div class="border-t border-white/20 pt-4 mt-4"><div class="flex justify-between items-center text-xl font-bold"><span>Total Project Cost:</span><span class="text-green-400">$${totalCost.toLocaleString()}</span></div></div>`;
            if (boqData.recommendations && boqData.recommendations.length > 0) {
                document.getElementById('recommendationsContent').innerHTML = boqData.recommendations.map(rec => `<div class="text-sm mb-1">üí° ${rec}</div>`).join('');
            }
        }
        
        function placeModelsFromBackend(boqData) {
            const itemsToPlace = [];
            if (boqData.categories) {
                Object.values(boqData.categories).forEach(cat => {
                    cat.items.forEach(item => {
                        for (let i = 0; i < item.quantity; i++) {
                            const fullProductData = allEquipmentData.find(p => p.id === item.productId);
                            if (fullProductData) itemsToPlace.push(fullProductData);
                        }
                    });
                });
            }
            const smartLayout = getSmartLayout(itemsToPlace);
            smartLayout.forEach((item, index) => {
                setTimeout(() => createEquipment(item.data, item.position), index * 50);
            });
        }
        
        // --- 3D VISUALIZATION ---
        function initThreeJS() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('renderContainer').appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 1.5;
            controls.minDistance = 2;
            controls.maxDistance = 50;
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            setupLighting();
            createRoom();
            camera.position.set(12, 8, 12);
            camera.lookAt(0, 0, 0);
            animate();
        }

        function setupLighting() {
            scene.add(new THREE.AmbientLight(0xcccccc, 0.5));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 15, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
        }

        function createRoom() {
            const existingRoom = scene.getObjectByName('room');
            if (existingRoom) scene.remove(existingRoom);
            const roomGroup = new THREE.Group();
            roomGroup.name = 'room';
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const context = canvas.getContext('2d');
            context.fillStyle = '#4a4a4a'; context.fillRect(0, 0, 64, 64);
            context.strokeStyle = '#5a5a5a'; context.lineWidth = 2;
            context.strokeRect(0, 0, 64, 64);
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping; texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(room.width, room.depth);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(room.width, room.depth), new THREE.MeshLambertMaterial({ map: texture }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            floor.name = "floor";
            roomGroup.add(floor);
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0x2d3748, side: THREE.DoubleSide });
            const backWall = new THREE.Mesh(new THREE.PlaneGeometry(room.width, room.height), wallMaterial);
            backWall.position.set(0, room.height / 2, -room.depth / 2);
            roomGroup.add(backWall);
            const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(room.depth, room.height), wallMaterial);
            leftWall.position.set(-room.width / 2, room.height / 2, 0);
            leftWall.rotation.y = Math.PI / 2;
            roomGroup.add(leftWall);
            if (room.width > 3.5 && room.depth > 2.5) roomGroup.add(createConferenceTable(room));
            scene.add(roomGroup);
            updateAnalytics();
        }

        function createConferenceTable() {
            const tableGroup = new THREE.Group();
            const tableWidth = Math.max(1.2, room.width * 0.5);
            const tableDepth = Math.max(2.4, room.depth * 0.6);
            const tabletop = new THREE.Mesh(new THREE.BoxGeometry(tableDepth, 0.05, tableWidth), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.4, metalness: 0.1 }));
            tabletop.position.y = TABLE_HEIGHT - 0.025;
            tabletop.castShadow = true; tabletop.receiveShadow = true;
            tableGroup.add(tabletop);
            return tableGroup;
        }

        function createEquipment(data, position = { x: 0, y: 0, z: 0 }) {
            const sizeInfo = equipmentSizeDatabase[data.category] || equipmentSizeDatabase['default'];
            const equipmentGroup = new THREE.Group();
            const bodyGeom = new THREE.BoxGeometry(sizeInfo.width, sizeInfo.height, sizeInfo.depth);
            const bodyMat = new THREE.MeshStandardMaterial({ color: sizeInfo.color, roughness: 0.4 });
            const body = new THREE.Mesh(bodyGeom, bodyMat);
            equipmentGroup.add(body);
            equipmentGroup.position.set(position.x, position.y, position.z);
            equipmentGroup.castShadow = true;
            equipmentGroup.userData = { ...data, placed: true };
            equipmentGroup.name = `equipment_${data.id}_${Date.now()}`;
            scene.add(equipmentGroup);
            placedEquipment.push(equipmentGroup);
            updateBOQ();
            updateAnalytics();
            return equipmentGroup;
        }
        
        // --- UI & EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('updateRoom').addEventListener('click', () => {
                room.width = parseFloat(document.getElementById('roomWidth').value) || 8;
                room.depth = parseFloat(document.getElementById('roomDepth').value) || 6;
                createRoom();
                showToast('Room updated successfully', 'success');
            });
            document.getElementById('equipmentSearch').addEventListener('input', (e) => filterEquipment(e.target.value.toLowerCase()));
            document.getElementById('quickGenerate').addEventListener('click', handleAIGenerateClick);
            document.getElementById('togglePanels').addEventListener('click', togglePanels);
            document.getElementById('loadRecommended').addEventListener('click', handleAIGenerateClick);
            document.getElementById('exportBOQ').addEventListener('click', exportBOQ);
            document.getElementById('clearAll').addEventListener('click', () => clearAllEquipment(true));
            document.getElementById('topView').addEventListener('click', () => setView('top'));
            document.getElementById('frontView').addEventListener('click', () => setView('front'));
            document.getElementById('isoView').addEventListener('click', () => setView('iso'));
            document.getElementById('resetView').addEventListener('click', () => setView('reset'));
            document.querySelectorAll('.room-preset-btn').forEach(btn => btn.addEventListener('click', (e) => applyRoomPreset(e.currentTarget.dataset.preset)));
            renderer.domElement.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onWindowResize);
        }
        
        function setupDragAndDrop() {
            const renderContainer = document.getElementById('renderContainer');
            renderContainer.addEventListener('dragover', (e) => e.preventDefault());
            renderContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    const rect = renderContainer.getBoundingClientRect();
                    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                    raycaster.setFromCamera(mouse, camera);
                    const floor = scene.getObjectByName("floor");
                    if (!floor) return;
                    const intersects = raycaster.intersectObject(floor);
                    if (intersects.length > 0) {
                        const pos = intersects[0].point;
                        const sizeInfo = equipmentSizeDatabase[data.category] || equipmentSizeDatabase['default'];
                        createEquipment(data, { x: pos.x, y: sizeInfo.height / 2, z: pos.z });
                    }
                } catch (error) { console.error('Drop error:', error); }
            });
        }

        function createEquipmentItem(data) {
            const item = document.createElement('div');
            item.className = 'equipment-item premium-glass rounded-lg p-3 mb-2';
            item.innerHTML = `<div class="font-semibold text-sm text-white truncate">${data.name}</div><div class="text-xs text-blue-300 mb-1">${data.brand} ‚Ä¢ ${data.model || data.category}</div><div class="flex items-center justify-between mt-2"><span class="text-sm font-bold text-green-400">$${data.price.toLocaleString()}</span><span class="text-xs uppercase font-bold text-white/70">${data.tier || 'Standard'}</span></div>`;
            item.draggable = true;
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('application/json', JSON.stringify(data));
                item.style.opacity = '0.5';
            });
            item.addEventListener('dragend', () => item.style.opacity = '1');
            return item;
        }

        // --- HELPER & UTILITY FUNCTIONS ---
        function updateBOQ() {
            const boqContent = document.getElementById('boqContent');
            if (placedEquipment.length === 0) {
                boqContent.innerHTML = `<div class="text-center text-white/60 py-8"><div>Drag items from the library to build a BOQ.</div></div>`;
                return;
            }
            const categories = {};
            let totalCost = 0;
            placedEquipment.forEach(item => {
                const data = item.userData;
                if (!categories[data.category]) categories[data.category] = [];
                categories[data.category].push(data);
                totalCost += data.price;
            });
            let html = '';
            Object.keys(categories).sort().forEach(categoryName => {
                const items = categories[categoryName];
                const categoryTotal = items.reduce((sum, item) => sum + item.price, 0);
                html += `<div class="boq-section"><h3 class="text-lg font-semibold mb-3 text-blue-300">${getCategoryIcon(categoryName)} ${categoryName}<span class="float-right text-green-400">$${categoryTotal.toLocaleString()}</span></h3>`;
                const itemCounts = {};
                items.forEach(item => { itemCounts[item.id] = (itemCounts[item.id] || 0) + 1; });
                Object.keys(itemCounts).forEach(itemId => {
                    const item = items.find(i => i.id === itemId);
                    const quantity = itemCounts[itemId];
                    const lineTotal = item.price * quantity;
                    html += `<div class="boq-item"><div class="font-semibold text-white">${item.name}</div><div class="text-xs text-white/60 mt-1">Qty: ${quantity} √ó $${item.price.toLocaleString()} = $${lineTotal.toLocaleString()}</div></div>`;
                });
                html += '</div>';
            });
            html += `<div class="border-t border-white/20 pt-4 mt-4"><div class="flex justify-between items-center text-xl font-bold"><span>Total Project Cost:</span><span class="text-green-400">$${totalCost.toLocaleString()}</span></div></div>`;
            boqContent.innerHTML = html;
        }

        function exportBOQ() {
            if (placedEquipment.length === 0) return showToast('No equipment to export.', 'error');
            let csv = 'Category,Item,Brand,Quantity,Unit Price,Total Price\n';
            const itemCounts = {};
            placedEquipment.forEach(item => { itemCounts[item.userData.id] = (itemCounts[item.userData.id] || 0) + 1; });
            Object.keys(itemCounts).forEach(itemId => {
                const item = placedEquipment.find(i => i.userData.id === itemId).userData;
                const quantity = itemCounts[itemId];
                csv += `"${item.category}","${item.name}","${item.brand}",${quantity},${item.price},${item.price * quantity}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = `BOQ_${document.getElementById('projectName').value.replace(/\s+/g, '_')}.csv`;
            a.click();
            showToast('BOQ exported successfully.', 'success');
        }

        function getCategoryIcon(category) {
            const icons = { 'Display': 'üì∫', 'Camera': 'üìπ', 'Audio': 'üéµ', 'Control': 'üéõÔ∏è', 'Network': 'üåê', 'UC': 'ü§ù' };
            for (const key in icons) if (category.includes(key)) return icons[key];
            return 'üì¶';
        }
        
        function getSmartLayout(items) {
            const layout = [];
            let counters = {};
            items.forEach(itemData => {
                let position = { x: 0, y: 0.5, z: 0 };
                const cat = itemData.category || 'default';
                counters[cat] = (counters[cat] || 0) + 1;
                let count = counters[cat];
                if (cat.includes('Display')) position = { x: 0, y: 1.5, z: -room.depth / 2 + 0.1 };
                else if (cat.includes('Camera') || cat.includes('UC')) position = { x: 0, y: room.height - 0.3, z: room.depth / 2 - 0.2 };
                else if (cat.includes('Microphone')) position = { x: 0, y: room.height - 0.1, z: 0 };
                else if (cat.includes('Speaker')) position = { x: (count % 2 === 0 ? 1 : -1) * (room.width / 4), y: room.height - 0.1, z: 0 };
                else if (cat.includes('Control')) position = { x: 0.5, y: TABLE_HEIGHT + 0.05, z: 0 };
                else position = { x: -room.width / 2 + 0.3 + (count * 0.5), y: 0.1, z: -room.depth / 2 + 0.3 };
                layout.push({ data: itemData, position });
            });
            return layout;
        }
        
        function clearAllEquipment(showConfirmation) {
            if (showConfirmation && placedEquipment.length > 0 && !confirm('Are you sure you want to remove all equipment from the scene?')) return;
            placedEquipment.forEach(item => scene.remove(item));
            placedEquipment = [];
            updateBOQ();
            updateAnalytics();
            if (showConfirmation) showToast('Scene cleared', 'success');
        }

        function togglePanels() {
            panelsVisible = !panelsVisible;
            const controlPanel = document.getElementById('controlPanel');
            const boqPanel = document.getElementById('boqPanel');
            controlPanel.style.transform = panelsVisible ? 'translateX(0)' : 'translateX(-110%)';
            boqPanel.style.transform = panelsVisible ? 'translateX(0)' : 'translateX(110%)';
        }

        function setView(viewType) {
            const distance = Math.max(room.width, room.depth) * 1.5;
            switch(viewType) {
                case 'top': camera.position.set(0, distance, 0.01); controls.target.set(0,0,0); break;
                case 'front': camera.position.set(0, room.height/2, distance); controls.target.set(0, room.height/2, 0); break;
                case 'iso': camera.position.set(distance * 0.8, distance * 0.6, distance * 0.8); controls.target.set(0,0,0); break;
                case 'reset': camera.position.set(12, 8, 12); controls.target.set(0,0,0); break;
            }
            controls.update();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast premium-glass rounded-lg p-4 max-w-sm border-l-4`;
            const colors = { success: 'border-green-500 text-green-300', error: 'border-red-500 text-red-300', info: 'border-blue-500 text-blue-300' };
            toast.classList.add(...(colors[type] || colors.info).split(' '));
            toast.innerHTML = `<div class="font-semibold">${message}</div>`;
            document.getElementById('toastContainer').appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.parentNode && toast.parentNode.removeChild(toast), 400);
            }, 3000);
        }

        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function updateAnalytics() {
            const totalCost = placedEquipment.reduce((sum, item) => sum + (item.userData.price || 0), 0);
            document.getElementById('equipmentCount').textContent = `${placedEquipment.length} items`;
            document.getElementById('coverageArea').textContent = `${(room.width * room.depth).toFixed(1)} m¬≤`;
            document.getElementById('quickStats').textContent = `Room: ${room.width}m√ó${room.depth}m | Items: ${placedEquipment.length} | Total: $${totalCost.toLocaleString()}`;
        }
        function onMouseClick() { /* Can be implemented later for item selection */ }
        function filterEquipment(searchTerm) {
            const items = document.querySelectorAll('#equipmentLibrary .equipment-item');
            items.forEach(item => {
                const name = item.querySelector('.font-semibold').textContent.toLowerCase();
                const brand = item.querySelector('.text-xs').textContent.toLowerCase();
                item.style.display = (name.includes(searchTerm) || brand.includes(searchTerm)) ? '' : 'none';
            });
        }
        function applyRoomPreset(preset) {
            const presets = {
                meeting: { width: 6, depth: 4, size: 'small', useCase: 'meeting_room', quality: 'standard' },
                boardroom: { width: 8, depth: 6, size: 'medium', useCase: 'boardroom', quality: 'premium' },
                auditorium: { width: 15, depth: 12, size: 'auditorium', useCase: 'auditorium', quality: 'enterprise' },
                huddle: { width: 4, depth: 3, size: 'small', useCase: 'huddle_room', quality: 'standard' }
            };
            const config = presets[preset];
            if (!config) return;
            document.getElementById('roomWidth').value = config.width;
            document.getElementById('roomDepth').value = config.depth;
            document.getElementById('roomSize').value = config.size;
            document.getElementById('useCase').value = config.useCase;
            document.getElementById('qualityLevel').value = config.quality;
            document.getElementById('updateRoom').click();
            showToast(`Applied ${preset} preset`, 'success');
        }

    </script>
</body>
</html>
